# Constructing metacells (for a 'discrete' data)

In this chapter, we will demonstrate metacell construction using three different methods. MetaCell-2 (MC2) and SEACells in Pyhton and SuperCell in R. 

For this, we will use a dataset of PBMCs from study. This dataset contains 30K cells and ... This is an example of a complex dataset with well defined cells types. For an example of more continuous data, see chapter \@ref(MC-continuous)

```{r include=FALSE}
TO_CACHE <- FALSE
```


```{r include=FALSE}
source('./R/config.R')
```


```{python true-import, echo = FALSE, result = FALSE, message = FALSE, warning = FALSE}
# This is true import section that is executed, but not displayed as it simultaneously load MC2 and SEACells.
# As MC2 and SEACells workflow displayed in separate files, while indeed they run in the same file/session (due to fact that in bookdown one and only one chapter per Rmd file)
# The following import chunks, specific to SEACells and MC2 are not executed, although displayed for users. 

import os
import numpy as np
import pandas as pd
import anndata as ad
import scanpy as sc
import matplotlib.pyplot as plt
import seaborn as sns
import metacells as mc
import SEACells
import random 

import sys
sys.path.append('./mc_QC/') 
import mc_QC
```


## MC2 (Python)

```{r, child = './sub_pages/21-mc2.Rmd'}

```


## SuperCell (R)


```{r, child='./sub_pages/21-supercell.Rmd'}
#yet to write, make sure to somehow clean environment before moving into a new MC construction
```



## SEACells (Python)

```{r child='./sub_pages/21-seacells.Rmd'}
# replce the code below with a single `./sub_pages/21-seacells.Rmd` file
```

Replace the following code with `./sub_pages/21-seacells.Rmd`

Constructing metacells with [SEACells](https://github.com/dpeerlab/SEACells). The code is adapted from [the authors' tutorial](https://github.com/dpeerlab/SEACells/blob/main/notebooks/SEACell_computation.ipynb).

SEACells work with [Anndata](https://anndata.readthedocs.io/en/latest/#) objects and used [Scanpy](https://scanpy.readthedocs.io/en/stable/) for pre-processing single-cell data and for the analysis of data at the metacell level (for the analysis, see section \@ref(standard-analysis-Py)).



#### Imports {-}
```{python, eval = FALSE}
import os
import pandas as pd
import scanpy as sc
import SEACells
import random 

import sys
sys.path.append('./mc_QC/') 
import mc_QC
```

#### Global parameters {-}
```{python parameters}
## Parameters
MC_tool = "SEACell"
gamma = 50   # the requested graining level

## Here we can modify dataset 
proj_name = ["cell_lines", "3k_pbmc"][1]

annotation_label = {'cell_lines':'cell_line',
                   '3k_pbmc':'louvain'}[proj_name]
```

#### Load data {-}

```{r seacelld-load-data, echo=FALSE, results='asis'}
res <- knitr::knit_child('./functional_chunks/load_anndata.Rmd', envir = environment(), quiet = TRUE)
cat(res, sep = '\n')
```

Saving count layers to a raw attribute as raw counts will be used for metacell aggregation.
```{python data-processing, cache = TO_CACHE}
# Save count as a separate layer
ad.layers['counts'] = ad.X

# Copy the counts to ".raw" attribute of the anndata since it is necessary for downstream analysis
# This step should be performed after filtering 
raw_ad = sc.AnnData(ad.layers['counts'])
raw_ad.obs_names, raw_ad.var_names = ad.obs_names, ad.var_names
ad.raw = raw_ad
```

```{r seacells-standard-preproc, echo=FALSE, results='asis'}
res <- knitr::knit_child('./functional_chunks/scanpy_standard_preproc.Rmd', envir = environment(), quiet = TRUE)
cat(res, sep = '\n')
```

### Running SEACells {-}
```{r seacells-workflow, echo=FALSE, results='asis'}
res <- knitr::knit_child('./functional_chunks/SEACell_workflow.Rmd', envir = environment(), quiet = TRUE)
cat(res, sep = '\n')
```

### Metacell QC {-}
```{r seacells-qc, echo=FALSE, results='asis'}
res <- knitr::knit_child('./functional_chunks/MC_QC.Rmd', envir = environment(), quiet = TRUE)
cat(res, sep = '\n')
```

### Save metacell object for further analysis {-}
```{r seacells-save, echo=FALSE, results='asis'}
res <- knitr::knit_child('./functional_chunks/save_mc_anndata.Rmd', envir = environment(), quiet = TRUE)
cat(res, sep = '\n')
```

```{python remove-variables, include = FALSE}
# Remove Seacell variables 
#del mc_ad
#del ad
globals().pop('ad', None);
globals().pop('mc_ad', None);
globals().pop('mc_INV', None);
globals().pop('mc_INV_val', None);
globals().pop('compactness', None);
globals().pop('separation', None);
globals().pop('mc_purity', None);
globals().pop('membership', None);
globals().pop('model', None);
globals().pop('mc_size', None);
globals().pop('mc_purity', None);
```

