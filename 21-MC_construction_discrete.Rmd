# Constructing metacells {#Metacell-construction-chapter}

In this chapter, we will demonstrate metacell construction using three different methods: SuperCell in R, MetaCell-2 (MC2) and SEACells in Pyhton. 

For this, we will first use a dataset of PBMC dataset from the SeuratData package. This dataset contains around 30K cells and is an example of a dataset with well defined cell types. 
For an example of more continuous data, see chapter \@ref(MC-continuous).

```{r include=FALSE}
TO_CACHE <- FALSE
```

```{r, eval = TRUE}
library(reticulate)
conda_env <-  conda_list()[reticulate::conda_list()$name == "base","python"]
# use_condaenv(conda_env)
use_python("/Users/admin/miniconda3/bin/python")
```

```{python true-import, message=FALSE, warning=FALSE, include=FALSE, result=FALSE}
# This is true import section that is executed, but not displayed as it simultaneously load MC2 and SEACells.
# As MC2 and SEACells workflow displayed in separate files, while indeed they run in the same file/session (due to fact that in bookdown one and only one chapter per Rmd file)
# The following import chunks, specific to SEACells and MC2 are not executed, although displayed for users. 

import os
import numpy as np
import pandas as pd
import anndata as ad
import scanpy as sc
import matplotlib.pyplot as plt
import seaborn as sns
import metacells as mc
import SEACells
import random 
import warnings
warnings.filterwarnings('ignore')

```

## SuperCell (R) {#SuperCell-construction}

```{r, child='./sub_pages/21-supercell.Rmd'}
```


<!-- ## MC2 (Python) {#MC2-construction} -->

<!-- ```{r, child = './sub_pages/21-mc2.Rmd'} -->
<!-- ``` -->


<!-- ## SEACells (Python) {#SEACells-construction} -->

<!-- ```{r child='./sub_pages/21-seacells.Rmd'} -->
<!-- ``` -->


<!-- We provide a command line tool allowing users to build metacells using either tool (MC2, SuperCell or SEACells) from a provided dataset. -->
<!-- The command line tool takes multiple parameters as input, *e.g.,* number of neighbors considered in the knn, number of components used, graining level. -->
<!-- which is for example required in a benchmark setting. -->


<!-- ```{bash, commandlines_setup, eval = FALSE} -->
<!-- setwd("MetacellToolkit/") -->
<!-- ``` -->

<!-- ```{bash, SuperCell-command, eval = FALSE} -->
<!-- proj_name="3k_pbmc" -->
<!-- MC_tool="SuperCell" -->
<!-- # input raw adata output adata -->
<!-- Rscript cli/${MC_tool}CL.R -i data/${proj_name}/singlecell_anndata_filtered.h5ad -o data/${proj_name}/${MC_tool}/ -n 50 -f 2000 -k 30 -g 50 -s adata -->

<!-- # input raw adata output seurat -->
<!-- Rscript cli/${MC_tool}CL.R -i data/${proj_name}/singlecell_anndata_filtered.h5ad -o data/${proj_name}/${MC_tool}/ -n 50 -f 2000 -k 30 -g 50 -s seurat -->
<!-- ``` -->


<!-- ```{bash, SEACells-command, eval = FALSE} -->
<!-- proj_name="3k_pbmc" -->
<!-- MC_tool="SEACells" -->
<!-- # input raw adata output adata -->
<!-- Rscript cli/${MC_tool}CL.R -i data/${proj_name}/singlecell_anndata_filtered.h5ad -o data/${proj_name}/${MC_tool}/ -n 50 -f 2000 -k 30 -g 50 -s adata -->

<!-- # input raw adata output seurat -->
<!-- Rscript cli/${MC_tool}CL.R -i data/${proj_name}/singlecell_anndata_filtered.h5ad -o data/${proj_name}/${MC_tool}/ -n 50 -f 2000 -k 30 -g 50 -s seurat -->
<!-- ``` -->
