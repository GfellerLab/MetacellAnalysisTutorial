<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 5 Metacell Analysis Toolkit (MCAT) | Metacell Analysis Tutorial</title>
<meta name="author" content="Aurélie Gabriel, Léonard Hérault, Mariia Bilous, David Gfeller">
<meta name="description" content="We provide a command line tool allowing users to build metacells using either tool (MC2, SuperCell or SEACells) from a provided dataset. The command line tool takes multiple parameters as input,...">
<meta name="generator" content="bookdown 0.36 with bs4_book()">
<meta property="og:title" content="Chapter 5 Metacell Analysis Toolkit (MCAT) | Metacell Analysis Tutorial">
<meta property="og:type" content="book">
<meta property="og:url" content="https://GfellerLab.github.io/MetacellAnalysisTutorial/command-line.html">
<meta property="og:description" content="We provide a command line tool allowing users to build metacells using either tool (MC2, SuperCell or SEACells) from a provided dataset. The command line tool takes multiple parameters as input,...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 5 Metacell Analysis Toolkit (MCAT) | Metacell Analysis Tutorial">
<meta name="twitter:description" content="We provide a command line tool allowing users to build metacells using either tool (MC2, SuperCell or SEACells) from a provided dataset. The command line tool takes multiple parameters as input,...">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.5.0/transition.js"></script><script src="libs/bs3compat-0.5.0/tabs.js"></script><script src="libs/bs3compat-0.5.0/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<style type="text/css">
    /* Used with Pandoc 2.11+ new --citeproc when CSL is used */
    div.csl-bib-body { }
    div.csl-entry {
      clear: both;
        }
    .hanging div.csl-entry {
      margin-left:2em;
      text-indent:-2em;
    }
    div.csl-left-margin {
      min-width:2em;
      float:left;
    }
    div.csl-right-inline {
      margin-left:2em;
      padding-left:1em;
    }
    div.csl-indent {
      margin-left: 2em;
    }
  </style>
<link rel="stylesheet" href="style.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Metacell Analysis Tutorial</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">This tutorial</a></li>
<li><a class="" href="requirements.html"><span class="header-section-number">1</span> Requirements</a></li>
<li><a class="" href="the-metacell-concept.html"><span class="header-section-number">2</span> The metacell concept</a></li>
<li><a class="" href="Metacell-construction-chapter.html"><span class="header-section-number">3</span> Constructing metacells</a></li>
<li><a class="" href="QCs.html"><span class="header-section-number">4</span> Metacells QCs</a></li>
<li><a class="active" href="command-line.html"><span class="header-section-number">5</span> Metacell Analysis Toolkit (MCAT)</a></li>
<li><a class="" href="downstream-analysis-of-metacells.html"><span class="header-section-number">6</span> Downstream analysis of metacells</a></li>
<li><a class="" href="integration.html"><span class="header-section-number">7</span> Integration of metacells</a></li>
<li><a class="" href="references.html">References</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/GfellerLab/MetacellAnalysisTutorial">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="command-line" class="section level1" number="5">
<h1>
<span class="header-section-number">5</span> Metacell Analysis Toolkit (MCAT)<a class="anchor" aria-label="anchor" href="#command-line"><i class="fas fa-link"></i></a>
</h1>
<p>We provide a command line tool allowing users to build metacells using either tool (MC2, SuperCell or SEACells) from a provided dataset.
The command line tool takes multiple parameters as input, <em>e.g.,</em> number of neighbors considered in the knn, number of components used, graining level.
which is for example required in a benchmark setting.</p>
<p>We will use this toolkit to analyse differentiating hematopoietic stem cells (Human CD34+).
Note that we retrieved the RNA data from a 10X multiome experiment but we won’t analyse the ATAC modality.
To retrieve this data, please refer to section <a href="requirements.html#CD34-data">1.3</a>.</p>
<div id="setting-up-the-environment" class="section level2" number="5.1">
<h2>
<span class="header-section-number">5.1</span> Setting up the environment<a class="anchor" aria-label="anchor" href="#setting-up-the-environment"><i class="fas fa-link"></i></a>
</h2>
<div class="sourceCode" id="cb74"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rstudio.github.io/reticulate/">reticulate</a></span><span class="op">)</span></span>
<span><span class="va">conda_env</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://rstudio.github.io/reticulate/reference/conda-tools.html">conda_list</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="fu">reticulate</span><span class="fu">::</span><span class="fu"><a href="https://rstudio.github.io/reticulate/reference/conda-tools.html">conda_list</a></span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="va">name</span> <span class="op">==</span> <span class="st">"MetacellAnalysisToolkit"</span>,<span class="st">"python"</span><span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Sys.setenv.html">Sys.setenv</a></span><span class="op">(</span>RETICULATE_PYTHON <span class="op">=</span> <span class="va">conda_env</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb75"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">SuperCell</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://satijalab.org/seurat">Seurat</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; The legacy packages maptools, rgdal, and rgeos, underpinning this package</span></span>
<span><span class="co">#&gt; will retire shortly. Please refer to R-spatial evolution reports on</span></span>
<span><span class="co">#&gt; https://r-spatial.org/r/2023/05/15/evolution4.html for details.</span></span>
<span><span class="co">#&gt; This package is now running under evolution status 0</span></span>
<span><span class="co">#&gt; Attaching SeuratObject</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://anndata.dynverse.org">anndata</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">MetacellAnalysisToolkit</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div id="metacell-building" class="section level2" number="5.2">
<h2>
<span class="header-section-number">5.2</span> Metacell building<a class="anchor" aria-label="anchor" href="#metacell-building"><i class="fas fa-link"></i></a>
</h2>
<p>Here we will use the MCAT bash command line to build the metacells with MetaCell2 and SuperCell.
To call the MCAT command line, please define your path to the gihub cloned repository optained from this <a href="https://github.com/GfellerLab/MetacellToolkit">github repository</a>.</p>
<div id="building-metacell-with-metacell2-mc2" class="section level3" number="5.2.1">
<h3>
<span class="header-section-number">5.2.1</span> Building metacell with MetaCell2 (MC2)<a class="anchor" aria-label="anchor" href="#building-metacell-with-metacell2-mc2"><i class="fas fa-link"></i></a>
</h3>
<p>We use MetaCell2 (<code>-t MetaCell</code>) to identify metacells at a gamma of 50 (<code>-g 50</code>). We specify that we want a Seurat .rds object in ouput (<code>-s seurat</code>).</p>
<div class="sourceCode" id="cb76"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb76-1"><a href="command-line.html#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="va">MCAT_path</span><span class="op">=</span>....</span>
<span id="cb76-2"><a href="command-line.html#cb76-2" aria-hidden="true" tabindex="-1"></a><span class="va">${MCAT_path}</span><span class="ex">/cli/MCAT</span> <span class="at">-t</span> MetaCell <span class="at">-i</span> data/CD34/cd34_multiome_rna.h5ad <span class="at">-o</span> data/CD34/MC2/ <span class="at">-g</span> 50 <span class="at">-s</span> seurat</span></code></pre></div>
</div>
<div id="building-metacell-with-supercell" class="section level3" number="5.2.2">
<h3>
<span class="header-section-number">5.2.2</span> Building metacell with SuperCell<a class="anchor" aria-label="anchor" href="#building-metacell-with-supercell"><i class="fas fa-link"></i></a>
</h3>
<p>We use SuperCell (<code>-t SuperCell</code>) to identify metacells at a gamma of 50 (<code>-g 50</code>). We specify that we want a Seurat .rds object in ouput (<code>-s seurat</code>).
We use 2000 highly variable genes (HVGs, <code>-f 2000</code>) to compute a PCA from which we use 50 components (<code>-n 50</code>) to make a k = 30 knn (<code>-k 30</code>) graph on which we identify the metacells.</p>
<div class="sourceCode" id="cb77"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb77-1"><a href="command-line.html#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="va">MCAT_path</span><span class="op">=</span>....</span>
<span id="cb77-2"><a href="command-line.html#cb77-2" aria-hidden="true" tabindex="-1"></a><span class="va">${MCAT_path}</span><span class="ex">/cli/MCAT</span> <span class="at">-t</span> SuperCell <span class="at">-i</span> data/CD34/cd34_multiome_rna.h5ad <span class="at">-o</span> data/CD34/SuperCell/ <span class="at">-f</span> 2000 <span class="at">-g</span> 50 <span class="at">-n</span> 50 <span class="at">-k</span> 30 <span class="at">-s</span> seurat</span></code></pre></div>
</div>
</div>
<div id="short-downstream-analysis-of-the-metacells" class="section level2" number="5.3">
<h2>
<span class="header-section-number">5.3</span> Short downstream analysis of the metacells<a class="anchor" aria-label="anchor" href="#short-downstream-analysis-of-the-metacells"><i class="fas fa-link"></i></a>
</h2>
<div id="metacell2-metacells" class="section level3" number="5.3.1">
<h3>
<span class="header-section-number">5.3.1</span> MetaCell2 metacells<a class="anchor" aria-label="anchor" href="#metacell2-metacells"><i class="fas fa-link"></i></a>
</h3>
<p>We load the object obtained with MCAT</p>
<div class="sourceCode" id="cb78"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cd34.metacell</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"data/CD34/MC2/mc_Seurat.rds"</span><span class="op">)</span></span>
<span><span class="va">cd34.metacell</span></span>
<span><span class="co">#&gt; An object of class Seurat </span></span>
<span><span class="co">#&gt; 12462 features across 140 samples within 1 assay </span></span>
<span><span class="co">#&gt; Active assay: RNA (12462 features, 0 variable features)</span></span></code></pre></div>
<p>We Normalize the metacells data, identify the HVGs, and we make a classical dimensionality reduction (first a PCA and then vizualisation with a UMAP).</p>
<div class="sourceCode" id="cb79"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cd34.metacell</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/NormalizeData.html">NormalizeData</a></span><span class="op">(</span><span class="va">cd34.metacell</span><span class="op">)</span></span>
<span><span class="va">cd34.metacell</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/FindVariableFeatures.html">FindVariableFeatures</a></span><span class="op">(</span><span class="va">cd34.metacell</span><span class="op">)</span></span>
<span><span class="va">cd34.metacell</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/ScaleData.html">ScaleData</a></span><span class="op">(</span><span class="va">cd34.metacell</span><span class="op">)</span></span>
<span><span class="co">#&gt; Centering and scaling data matrix</span></span>
<span><span class="va">cd34.metacell</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/RunPCA.html">RunPCA</a></span><span class="op">(</span><span class="va">cd34.metacell</span><span class="op">)</span></span>
<span><span class="co">#&gt; PC_ 1 </span></span>
<span><span class="co">#&gt; Positive:  NUP210, MIS18BP1, LCP1, IQGAP1, P4HB, SLC2A4RG, COLGALT1, GRB2, ARHGEF18, BRI3BP </span></span>
<span><span class="co">#&gt;     RBL1, AGTPBP1, GGA2, TTC7A, PTPRE, IL17RA, CLEC12A, SLC4A7, CEP128, ARHGAP26 </span></span>
<span><span class="co">#&gt;     LINC01572, UVRAG, LCORL, LRP8, MAP3K1, PDE3B, UBE2E2, GEN1, NSD2, SND1 </span></span>
<span><span class="co">#&gt; Negative:  RPL34, MEIS1, NKAIN2, CHRM3, LAPTM4B, RPL11, ANGPT1, PRKG1, INPP4B, NRIP1 </span></span>
<span><span class="co">#&gt;     RPS2, PDZD2, CRHBP, GPC5, NPR3, PRKG2, ITGA9, CASC15, BEX2, ST8SIA6 </span></span>
<span><span class="co">#&gt;     YES1, DAPK1, ITGA9-AS1, MSI2, MED12L, NFATC2, HMGA2, RPS18, SLC8A3, CHRM3-AS2 </span></span>
<span><span class="co">#&gt; PC_ 2 </span></span>
<span><span class="co">#&gt; Positive:  TFR2, GATA1, UROD, KLF1, DNPH1, ANK1, TIMM13, PRDX2, XACT, ADAMTS3 </span></span>
<span><span class="co">#&gt;     MYC, EPOR, RYR3, TMEM14C, PLIN2, CNRIP1, KEL, CSF1, PTH2R, CYTOR </span></span>
<span><span class="co">#&gt;     MPST, P2RX5, SPTBN2, ELOVL6, SLC40A1, CXADR, SLC39A3, ZFPM1, NMNAT3, FADS2 </span></span>
<span><span class="co">#&gt; Negative:  AKAP13, VIM, CD74, PRKCB, STK17B, CYTH1, HLA-DQB1, DOCK10, SBF2, RASSF2 </span></span>
<span><span class="co">#&gt;     PRKCE, TSC22D3, PLCB1, CD44, ANKRD44, DST, HDAC9, PDE4B, HLA-DRA, TCF4 </span></span>
<span><span class="co">#&gt;     CALCRL, IDS, TGFBR2, SLCO3A1, POU2F2, AKNA, NEGR1, YPEL5, FYN, COL24A1 </span></span>
<span><span class="co">#&gt; PC_ 3 </span></span>
<span><span class="co">#&gt; Positive:  MYL12A, CARD11, PLP2, CCDC69, LGMN, CTSB, CST3, ARL4C, LIME1, PCED1B </span></span>
<span><span class="co">#&gt;     CYTH4, CDKN2D, IQSEC1, RNASE6, IGFLR1, CYB561A3, NCF1, PCED1B-AS1, SPIB, FAM160A1 </span></span>
<span><span class="co">#&gt;     CCDC50, MPEG1, RUBCNL, CYBB, GABARAP, LY96, UGCG, TGFBI, IGF2R, HLA-DMA </span></span>
<span><span class="co">#&gt; Negative:  ANKRD28, LRMDA, EREG, SNHG25, IRAK3, FNDC3B, PCBP3, CSF3R, RAB44, AZU1 </span></span>
<span><span class="co">#&gt;     GPI, MTUS2, SLC22A15, SLC22A4, DENND3, ATP8B4, ELANE, ERLIN1, MARC1, TENT5A </span></span>
<span><span class="co">#&gt;     SLC36A4, DSTYK, IL1RAP, RFX8, MS4A3, MFSD10, PKP2, CEP170, RAB27A, HGF </span></span>
<span><span class="co">#&gt; PC_ 4 </span></span>
<span><span class="co">#&gt; Positive:  EVI5, TET2, CPQ, FCGRT, SRGN, DENND4A, THEMIS2, RNH1, SUCLG2, PIP5K1B </span></span>
<span><span class="co">#&gt;     NR4A2, S100A6, FAM102B, CD4, FGD4, EMP3, CPPED1, EHBP1L1, NID1, AOAH </span></span>
<span><span class="co">#&gt;     ARHGEF12, PHTF1, GRASP, ZNF385A, PRKCA, RIPOR3, PRKAR2B, SAT1, CHD7, KCNQ1 </span></span>
<span><span class="co">#&gt; Negative:  SMIM24, IGLL1, PHGDH, SPARC, LGALS3BP, ITM2C, MZB1, CD69, IGFBP7, SPINK2 </span></span>
<span><span class="co">#&gt;     LAT2, TMIGD2, C1QTNF4, RPLP1, DOCK1, GYPC, ARMH1, CDK6, ADA, SDK2 </span></span>
<span><span class="co">#&gt;     FLT3, PIK3R1, BAALC, PLCB1, SATB1, LRRC26, ARHGAP25, CYFIP2, LNCAROD, PROM1 </span></span>
<span><span class="co">#&gt; PC_ 5 </span></span>
<span><span class="co">#&gt; Positive:  CIT, C21orf58, NUF2, KIF15, SPC25, DIAPH3, SMC4, NDC80, CDCA5, RRM2 </span></span>
<span><span class="co">#&gt;     ESCO2, CDC25C, DEPDC1B, RTKN2, HIST1H4C, MELK, MFGE8, SKA3, KIF20B, NUSAP1 </span></span>
<span><span class="co">#&gt;     NCAPG, ESPL1, EXO1, TACC3, RRM1, NCAPG2, PLK4, E2F8, KIF11, CDK1 </span></span>
<span><span class="co">#&gt; Negative:  SOX4, ACTG1, MIR181A1HG, LINC00173, MED13L, IGFBP7, IL2RG, HCST, SLC43A2, SATB1 </span></span>
<span><span class="co">#&gt;     ABHD17B, ARPP21, TMSB10, TRPM2, LAT2, DNTT, SLC45A3, MYO1G, S100Z, SMAD7 </span></span>
<span><span class="co">#&gt;     REEP5, RPLP1, LINC01934, TNFRSF21, RBMS3, WDR66, MZB1, COBL, CDK6, MOB1B</span></span>
<span><span class="va">cd34.metacell</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/RunUMAP.html">RunUMAP</a></span><span class="op">(</span><span class="va">cd34.metacell</span>,dims <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">50</span><span class="op">)</span>,min.dist <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: The default method for RunUMAP has changed from calling Python UMAP via reticulate to the R-native UWOT using the cosine metric</span></span>
<span><span class="co">#&gt; To use Python UMAP via reticulate, set umap.method to 'umap-learn' and metric to 'correlation'</span></span>
<span><span class="co">#&gt; This message will be shown once per session</span></span>
<span><span class="co">#&gt; 15:31:12 UMAP embedding parameters a = 0.583 b = 1.334</span></span>
<span><span class="co">#&gt; 15:31:12 Read 140 rows and found 50 numeric columns</span></span>
<span><span class="co">#&gt; 15:31:12 Using Annoy for neighbor search, n_neighbors = 30</span></span>
<span><span class="co">#&gt; 15:31:12 Building Annoy index with metric = cosine, n_trees = 50</span></span>
<span><span class="co">#&gt; 0%   10   20   30   40   50   60   70   80   90   100%</span></span>
<span><span class="co">#&gt; [----|----|----|----|----|----|----|----|----|----|</span></span>
<span><span class="co">#&gt; **************************************************|</span></span>
<span><span class="co">#&gt; 15:31:12 Writing NN index file to temp file /tmp/35398939/RtmpceShhA/file2a870e7114758a</span></span>
<span><span class="co">#&gt; 15:31:12 Searching Annoy index using 1 thread, search_k = 3000</span></span>
<span><span class="co">#&gt; 15:31:12 Annoy recall = 100%</span></span>
<span><span class="co">#&gt; 15:31:13 Commencing smooth kNN distance calibration using 1 thread with target n_neighbors = 30</span></span>
<span><span class="co">#&gt; 15:31:13 Initializing from normalized Laplacian + noise (using irlba)</span></span>
<span><span class="co">#&gt; 15:31:13 Commencing optimization for 500 epochs, with 4956 positive edges</span></span>
<span><span class="co">#&gt; 15:31:13 Optimization finished</span></span></code></pre></div>
<p>Plot the results using Seurat.</p>
<div class="sourceCode" id="cb80"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">umap.metacell</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/DimPlot.html">UMAPPlot</a></span><span class="op">(</span><span class="va">cd34.metacell</span>,group.by <span class="op">=</span> <span class="st">"celltype"</span>,label <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="va">umap.metacell</span></span></code></pre></div>
<div class="inline-figure"><img src="23-downstream_continuous_files/figure-html/unnamed-chunk-10-1.png" width="672"></div>
<p>We correctly retrieve the two main differentiation path of CD34+ cells.
In one hand, Megakaryocyte Erythrocyte Progenitor (MEP) fate with GATA2 and then GATA1 transcription factor expression.
On the other, Lymphoid Myeloid Multipotent Progenitor (LMPP) fate with SPI1 transcription factor expression.</p>
<div class="sourceCode" id="cb81"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">genes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"CD34"</span>,<span class="st">"GATA2"</span>,<span class="st">"GATA1"</span>,<span class="st">"SPI1"</span><span class="op">)</span></span>
<span><span class="va">marker.metacell.umaps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">genes</span>, FUN <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">plot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/FeaturePlot.html">FeaturePlot</a></span><span class="op">(</span><span class="va">cd34.metacell</span>, features <span class="op">=</span> <span class="va">x</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span>
<span><span class="va">marker.metacell.umaps</span></span>
<span><span class="co">#&gt; [[1]]</span></span></code></pre></div>
<div class="inline-figure"><img src="23-downstream_continuous_files/figure-html/unnamed-chunk-11-1.png" width="672"></div>
<pre><code>#&gt; 
#&gt; [[2]]</code></pre>
<div class="inline-figure"><img src="23-downstream_continuous_files/figure-html/unnamed-chunk-11-2.png" width="672"></div>
<pre><code>#&gt; 
#&gt; [[3]]</code></pre>
<div class="inline-figure"><img src="23-downstream_continuous_files/figure-html/unnamed-chunk-11-3.png" width="672"></div>
<pre><code>#&gt; 
#&gt; [[4]]</code></pre>
<div class="inline-figure">
<img src="23-downstream_continuous_files/figure-html/unnamed-chunk-11-4.png" width="672">
When analyzing metacells it’s a good idea to plot their size on these. We can do it with ggplot.</div>
<div class="sourceCode" id="cb85"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">umap.metacell</span><span class="op">$</span><span class="va">data</span>, <span class="va">cd34.metacell</span><span class="op">$</span><span class="va">size</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"size"</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">data</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span> <span class="va">UMAP_1</span>,y<span class="op">=</span><span class="va">UMAP_2</span>,color <span class="op">=</span> <span class="va">celltype</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>size<span class="op">=</span><span class="va">size</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_classic</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="23-downstream_continuous_files/figure-html/unnamed-chunk-12-1.png" width="672"></div>
<div class="sourceCode" id="cb86"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">marker.metacell.umaps</span>,FUN <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">data</span>,<span class="va">cd34.metacell</span><span class="op">$</span><span class="va">size</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"size"</span></span>
<span>  <span class="va">gene</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">data</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span> <span class="va">UMAP_1</span>,y<span class="op">=</span><span class="va">UMAP_2</span>,size<span class="op">=</span><span class="va">size</span>,colour <span class="op">=</span> <span class="va">.data</span><span class="op">[[</span><span class="va">gene</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html">scale_color_gradientn</a></span><span class="op">(</span>colors <span class="op">=</span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"lightgrey"</span>, <span class="st">"blue"</span><span class="op">)</span>, </span>
<span>                          guide <span class="op">=</span> <span class="st">"colorbar"</span><span class="op">)</span>  <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_classic</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="va">gene</span><span class="op">)</span></span>
<span><span class="op">}</span> <span class="op">)</span></span>
<span><span class="co">#&gt; [[1]]</span></span></code></pre></div>
<div class="inline-figure"><img src="23-downstream_continuous_files/figure-html/unnamed-chunk-13-1.png" width="672"></div>
<pre><code>#&gt; 
#&gt; [[2]]</code></pre>
<div class="inline-figure"><img src="23-downstream_continuous_files/figure-html/unnamed-chunk-13-2.png" width="672"></div>
<pre><code>#&gt; 
#&gt; [[3]]</code></pre>
<div class="inline-figure"><img src="23-downstream_continuous_files/figure-html/unnamed-chunk-13-3.png" width="672"></div>
<pre><code>#&gt; 
#&gt; [[4]]</code></pre>
<div class="inline-figure">
<img src="23-downstream_continuous_files/figure-html/unnamed-chunk-13-4.png" width="672">
### SuperCell metacells</div>
<p>We can do the same with the metacells obtained with SuperCell</p>
<p>We load the object obtained with MCAT</p>
<div class="sourceCode" id="cb90"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cd34.supercell</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"data/CD34/SuperCell/mc_Seurat.rds"</span><span class="op">)</span></span>
<span><span class="va">cd34.supercell</span></span>
<span><span class="co">#&gt; An object of class Seurat </span></span>
<span><span class="co">#&gt; 12464 features across 138 samples within 1 assay </span></span>
<span><span class="co">#&gt; Active assay: RNA (12464 features, 0 variable features)</span></span></code></pre></div>
<p>We Normalize the supercells data, identify the HVGs, and we make a classical dimensionality reduction (first a PCA and then vizualisation with a UMAP).</p>
<div class="sourceCode" id="cb91"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cd34.supercell</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/NormalizeData.html">NormalizeData</a></span><span class="op">(</span><span class="va">cd34.supercell</span><span class="op">)</span></span>
<span><span class="va">cd34.supercell</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/FindVariableFeatures.html">FindVariableFeatures</a></span><span class="op">(</span><span class="va">cd34.supercell</span><span class="op">)</span></span>
<span><span class="va">cd34.supercell</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/ScaleData.html">ScaleData</a></span><span class="op">(</span><span class="va">cd34.supercell</span><span class="op">)</span></span>
<span><span class="co">#&gt; Centering and scaling data matrix</span></span>
<span><span class="va">cd34.supercell</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/RunPCA.html">RunPCA</a></span><span class="op">(</span><span class="va">cd34.supercell</span><span class="op">)</span></span>
<span><span class="co">#&gt; PC_ 1 </span></span>
<span><span class="co">#&gt; Positive:  TST, NECTIN1, PCLAF, BLVRB, CD36, S100A6, CCDC26, PPP1R14A, PMP22, ANK1 </span></span>
<span><span class="co">#&gt;     ECE1, KLF1, KEL, PLIN2, KCNH2, ADAMTS3, EPOR, CKS1B, HBD, CSF1 </span></span>
<span><span class="co">#&gt;     PRKAR2B, HES6, GATA1, H2AFX, CXADR, APOC1, CENPM, TFR2, APOE, CSF2RB </span></span>
<span><span class="co">#&gt; Negative:  PRKCH, MIR99AHG, RBPMS, CD109, LINC01122, CRHBP, FAM169A, SCML4, ADGRG6, GUCY1A1 </span></span>
<span><span class="co">#&gt;     ABLIM1, NRIP1, MEIS1, SGCZ, NBEA, TMEM163, RORA, MAGI2, PRDM16, ROBO4 </span></span>
<span><span class="co">#&gt;     FGD5, RABGAP1, RNF220, L3MBTL4, ITGA9, SPTBN1, PTPRM, PROM1, MPPED2, IL12RB2 </span></span>
<span><span class="co">#&gt; PC_ 2 </span></span>
<span><span class="co">#&gt; Positive:  PRKCE, GAS7, SPNS3, HDAC9, AFF3, CRYBG1, CYTH1, NEGR1, RUNX2, LRRFIP1 </span></span>
<span><span class="co">#&gt;     MAP3K8, PDE4B, RASGEF1B, RAB11FIP1, FLT3, PRAG1, FAM107B, ITGAL, TIMP2, SDK2 </span></span>
<span><span class="co">#&gt;     HLA-DMB, PLD4, IRF8, APP, LGALS1, AHNAK, ARL4C, PAG1, ZFP36, TSPOAP1 </span></span>
<span><span class="co">#&gt; Negative:  STON2, TAL1, ZNF385D, MYH10, ALDH1A1, VPS37B, CDC42BPA, SLC40A1, DNAJC6, ST8SIA6 </span></span>
<span><span class="co">#&gt;     CYTL1, UROD, PHTF1, TNIK, ABO, NFIA, PIP5K1B, PDZD2, SORBS1, ZNF385D-AS2 </span></span>
<span><span class="co">#&gt;     TRIM58, ICAM4, XACT, ZFPM1, GATA1, HNRNPLL, ARHGEF12, TFR2, RYR3, MINPP1 </span></span>
<span><span class="co">#&gt; PC_ 3 </span></span>
<span><span class="co">#&gt; Positive:  EXT1, RGS1, CARD11, MAPRE2, P2RY14, TMEM59, LGMN, JCHAIN, CCND3, SETBP1 </span></span>
<span><span class="co">#&gt;     CYTH4, CD37, IGF2R, ITM2B, HLA-DMA, ADAM19, LIME1, IL18R1, PMEPA1, HLA-DRA </span></span>
<span><span class="co">#&gt;     UGCG, HLA-DPA1, RASD1, LINC01226, SLC9A7, CDKN2D, HLA-DPB1, SPIB, FAM160A1, TSBP1 </span></span>
<span><span class="co">#&gt; Negative:  FNDC3B, RAB44, SLC22A4, AZU1, PLPPR3, RFX8, PLD1, RAB27A, LRMDA, ELANE </span></span>
<span><span class="co">#&gt;     PCBP3, HGF, CST7, NT5DC3, C16orf74, CTSG, MTUS2, SLC22A15, YBX3, CFD </span></span>
<span><span class="co">#&gt;     MPO, IL1RAP, MS4A3, SLC1A3, AFF2, PRTN3, LYST, NR6A1, IGFBP2, CSF3R </span></span>
<span><span class="co">#&gt; PC_ 4 </span></span>
<span><span class="co">#&gt; Positive:  IGLL1, PHGDH, LGALS3BP, TSPAN7, SMIM24, PTPRD, NDC80, SKA3, MXD3, BAALC </span></span>
<span><span class="co">#&gt;     SPC25, SPARC, CDKN3, FANCD2, KIF2C, FBXO43, ESCO2, RAD51AP1, CDCA5, CDK1 </span></span>
<span><span class="co">#&gt;     PRDX1, ARHGAP11B, ITGA6, DEPDC1B, MYLK, BAALC-AS1, TPX2, MREG, MYO5C, SPC24 </span></span>
<span><span class="co">#&gt; Negative:  KCNQ1, OSCAR, GRASP, ADAM8, ADAP1, FCGRT, FGD4, KDM7A, CTSH, CD86 </span></span>
<span><span class="co">#&gt;     NR4A2, CD4, ENTPD1, LYZ, VDR, NAMPT, HCK, CSTA, ITGAX, PER1 </span></span>
<span><span class="co">#&gt;     GABARAPL1, MNDA, FAM102B, CFP, ZNF503, TNFAIP2, PPARD, LRP1, NLRP12, RETN </span></span>
<span><span class="co">#&gt; PC_ 5 </span></span>
<span><span class="co">#&gt; Positive:  DNTT, LINC00426, GABPB1-AS1, SCN3A, VPREB1, LTB, LINC01237, ARPP21, MME, PCAT14 </span></span>
<span><span class="co">#&gt;     CD79A, CD96, ERGIC1, CYGB, IL7R, EBF1, LINC00173, CD79B, LINC01934, UMODL1 </span></span>
<span><span class="co">#&gt;     SCAI, ATP1A3, LGALS3BP, C5orf56, RETREG1, SLC43A2, SIDT1, LINC01375, SPON1, COBL </span></span>
<span><span class="co">#&gt; Negative:  AURKB, TOP2A, DEPDC1B, UBE2C, CDCA3, CKAP2L, ASPM, NUSAP1, KIF4A, KIF14 </span></span>
<span><span class="co">#&gt;     KIFC1, PRC1, GTSE1, CIT, KIF18B, NUF2, CDK1, KIF15, KIF11, FOXM1 </span></span>
<span><span class="co">#&gt;     BIRC5, CCNA2, CDC25C, MKI67, TUBB4B, CDCA8, TPX2, CENPE, KIF23, CDCA2</span></span>
<span><span class="va">cd34.supercell</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/RunUMAP.html">RunUMAP</a></span><span class="op">(</span><span class="va">cd34.supercell</span>,dims <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">50</span><span class="op">)</span>,min.dist <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span><span class="co">#&gt; 15:31:18 UMAP embedding parameters a = 0.583 b = 1.334</span></span>
<span><span class="co">#&gt; 15:31:18 Read 138 rows and found 50 numeric columns</span></span>
<span><span class="co">#&gt; 15:31:18 Using Annoy for neighbor search, n_neighbors = 30</span></span>
<span><span class="co">#&gt; 15:31:18 Building Annoy index with metric = cosine, n_trees = 50</span></span>
<span><span class="co">#&gt; 0%   10   20   30   40   50   60   70   80   90   100%</span></span>
<span><span class="co">#&gt; [----|----|----|----|----|----|----|----|----|----|</span></span>
<span><span class="co">#&gt; **************************************************|</span></span>
<span><span class="co">#&gt; 15:31:18 Writing NN index file to temp file /tmp/35398939/RtmpceShhA/file2a870e33935643</span></span>
<span><span class="co">#&gt; 15:31:18 Searching Annoy index using 1 thread, search_k = 3000</span></span>
<span><span class="co">#&gt; 15:31:18 Annoy recall = 100%</span></span>
<span><span class="co">#&gt; 15:31:19 Commencing smooth kNN distance calibration using 1 thread with target n_neighbors = 30</span></span>
<span><span class="co">#&gt; 15:31:19 Initializing from normalized Laplacian + noise (using irlba)</span></span>
<span><span class="co">#&gt; 15:31:19 Commencing optimization for 500 epochs, with 4504 positive edges</span></span>
<span><span class="co">#&gt; 15:31:19 Optimization finished</span></span></code></pre></div>
<p>Plot the results using Seurat.</p>
<div class="sourceCode" id="cb92"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">umap.supercell</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/DimPlot.html">UMAPPlot</a></span><span class="op">(</span><span class="va">cd34.supercell</span>,group.by <span class="op">=</span> <span class="st">"celltype"</span>,label <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="va">umap.supercell</span></span></code></pre></div>
<div class="inline-figure">
<img src="23-downstream_continuous_files/figure-html/unnamed-chunk-16-1.png" width="672">
We correctly retrieve the two main differentiation path of CD34+ cells.
In one hand, Megakaryocyte Erythrocyte Progenitor (MEP) fate with GATA2 and then GATA1 transcription factor expression.
On the other, Lymphoid Myeloid Multipotent Progenitor (LMPP) fate with SPI1 transcription factor expression.</div>
<div class="sourceCode" id="cb93"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">genes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"CD34"</span>,<span class="st">"GATA2"</span>,<span class="st">"GATA1"</span>,<span class="st">"SPI1"</span><span class="op">)</span></span>
<span><span class="va">marker.supercell.umaps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">genes</span>, FUN <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">plot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/FeaturePlot.html">FeaturePlot</a></span><span class="op">(</span><span class="va">cd34.supercell</span>, features <span class="op">=</span> <span class="va">x</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span>
<span><span class="va">marker.supercell.umaps</span></span>
<span><span class="co">#&gt; [[1]]</span></span></code></pre></div>
<div class="inline-figure"><img src="23-downstream_continuous_files/figure-html/unnamed-chunk-17-1.png" width="672"></div>
<pre><code>#&gt; 
#&gt; [[2]]</code></pre>
<div class="inline-figure"><img src="23-downstream_continuous_files/figure-html/unnamed-chunk-17-2.png" width="672"></div>
<pre><code>#&gt; 
#&gt; [[3]]</code></pre>
<div class="inline-figure"><img src="23-downstream_continuous_files/figure-html/unnamed-chunk-17-3.png" width="672"></div>
<pre><code>#&gt; 
#&gt; [[4]]</code></pre>
<div class="inline-figure">
<img src="23-downstream_continuous_files/figure-html/unnamed-chunk-17-4.png" width="672">
When analyzing supercells it’s a good idea to plot their size on these. We can do it with ggplot.</div>
<div class="sourceCode" id="cb97"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">umap.supercell</span><span class="op">$</span><span class="va">data</span>,<span class="va">cd34.supercell</span><span class="op">$</span><span class="va">size</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"size"</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">data</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span> <span class="va">UMAP_1</span>,y<span class="op">=</span><span class="va">UMAP_2</span>,color <span class="op">=</span> <span class="va">celltype</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>size<span class="op">=</span><span class="va">size</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_classic</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="23-downstream_continuous_files/figure-html/unnamed-chunk-18-1.png" width="672"></div>
<div class="sourceCode" id="cb98"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">marker.supercell.umaps</span>,FUN <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">data</span>,<span class="va">cd34.supercell</span><span class="op">$</span><span class="va">size</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"size"</span></span>
<span>  <span class="va">gene</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">data</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span> <span class="va">UMAP_1</span>,y<span class="op">=</span><span class="va">UMAP_2</span>,size<span class="op">=</span><span class="va">size</span>,colour <span class="op">=</span> <span class="va">.data</span><span class="op">[[</span><span class="va">gene</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html">scale_color_gradientn</a></span><span class="op">(</span>colors <span class="op">=</span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"lightgrey"</span>, <span class="st">"blue"</span><span class="op">)</span>, </span>
<span>                          guide <span class="op">=</span> <span class="st">"colorbar"</span><span class="op">)</span>  <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_classic</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="va">gene</span><span class="op">)</span></span>
<span><span class="op">}</span> <span class="op">)</span></span>
<span><span class="co">#&gt; [[1]]</span></span></code></pre></div>
<div class="inline-figure"><img src="23-downstream_continuous_files/figure-html/unnamed-chunk-19-1.png" width="672"></div>
<pre><code>#&gt; 
#&gt; [[2]]</code></pre>
<div class="inline-figure"><img src="23-downstream_continuous_files/figure-html/unnamed-chunk-19-2.png" width="672"></div>
<pre><code>#&gt; 
#&gt; [[3]]</code></pre>
<div class="inline-figure"><img src="23-downstream_continuous_files/figure-html/unnamed-chunk-19-3.png" width="672"></div>
<pre><code>#&gt; 
#&gt; [[4]]</code></pre>
<div class="inline-figure"><img src="23-downstream_continuous_files/figure-html/unnamed-chunk-19-4.png" width="672"></div>
</div>
</div>
<div id="qc-with-the-metacellanalysistoolkit-package" class="section level2" number="5.4">
<h2>
<span class="header-section-number">5.4</span> QC with the MetacellAnalysisToolkit package<a class="anchor" aria-label="anchor" href="#qc-with-the-metacellanalysistoolkit-package"><i class="fas fa-link"></i></a>
</h2>
<div id="loading-single-cell-data" class="section level3" number="5.4.1">
<h3>
<span class="header-section-number">5.4.1</span> Loading single-cell data<a class="anchor" aria-label="anchor" href="#loading-single-cell-data"><i class="fas fa-link"></i></a>
</h3>
<p>First we need to load the single cell data and make a classical dimentionality reduction analysis.</p>
<div class="sourceCode" id="cb102"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cd34.singlecells</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://anndata.dynverse.org/reference/read_h5ad.html">read_h5ad</a></span><span class="op">(</span><span class="st">"data/CD34/cd34_multiome_rna.h5ad"</span><span class="op">)</span></span>
<span><span class="va">cd34.singlecells</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/CreateSeuratObject.html">CreateSeuratObject</a></span><span class="op">(</span>counts <span class="op">=</span> <span class="fu">Matrix</span><span class="fu">::</span><span class="fu">t</span><span class="op">(</span><span class="va">cd34.singlecells</span><span class="op">$</span><span class="va">X</span><span class="op">)</span>,meta.data <span class="op">=</span> <span class="va">cd34.singlecells</span><span class="op">$</span><span class="va">obs</span><span class="op">)</span></span>
<span><span class="va">cd34.singlecells</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/NormalizeData.html">NormalizeData</a></span><span class="op">(</span><span class="va">cd34.singlecells</span><span class="op">)</span></span>
<span><span class="va">cd34.singlecells</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/FindVariableFeatures.html">FindVariableFeatures</a></span><span class="op">(</span><span class="va">cd34.singlecells</span><span class="op">)</span></span>
<span><span class="va">cd34.singlecells</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/ScaleData.html">ScaleData</a></span><span class="op">(</span><span class="va">cd34.singlecells</span><span class="op">)</span></span>
<span><span class="co">#&gt; Centering and scaling data matrix</span></span>
<span><span class="va">cd34.singlecells</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/RunPCA.html">RunPCA</a></span><span class="op">(</span><span class="va">cd34.singlecells</span><span class="op">)</span></span>
<span><span class="co">#&gt; PC_ 1 </span></span>
<span><span class="co">#&gt; Positive:  NKAIN2, MEIS1, CRHBP, INPP4B, CALN1, CHRM3, AVP, PCDH9, GPC5, PRKG1 </span></span>
<span><span class="co">#&gt;     ANGPT1, MECOM, MIR99AHG, PRKG2, PBX1, PRKCH, SKAP1, PREX2, ZNF385D, THRB </span></span>
<span><span class="co">#&gt;     IL12A-AS1, RBPMS, HLF, LIMCH1, LINC01122, ST8SIA6, TMEM163, MED12L, CABLES1, PDZD2 </span></span>
<span><span class="co">#&gt; Negative:  DIAPH3, POLQ, RRM2, ASPM, TUBB, MKI67, TOP2A, CIT, TUBA1B, BRIP1 </span></span>
<span><span class="co">#&gt;     NUSAP1, CLSPN, ATAD2, SHCBP1, H2AFZ, STMN1, TMPO, KIF15, NCAPG2, DTL </span></span>
<span><span class="co">#&gt;     CENPF, GTSE1, KNL1, PCLAF, HMGN2, ACTB, UHRF1, ZNF367, MELK, AURKB </span></span>
<span><span class="co">#&gt; PC_ 2 </span></span>
<span><span class="co">#&gt; Positive:  PLCB1, NEGR1, PRKCE, AFF3, ATP8B4, SAMHD1, CD44, UBE2E2, MPO, PTPRE </span></span>
<span><span class="co">#&gt;     TTC7A, FLT3, ARHGAP26, GAS7, VIM, RELL1, AKAP13, RAB11FIP1, RUNX2, HDAC9 </span></span>
<span><span class="co">#&gt;     PLD4, ADGRE5, SLC8A1, KLF6, IRF8, SFMBT2, CD74, RBM47, GAB2, SDK2 </span></span>
<span><span class="co">#&gt; Negative:  ANK1, RYR3, XACT, ITGA2B, APOC1, EEF1A1, TFR2, CPB1, KLF1, RPS3 </span></span>
<span><span class="co">#&gt;     APOE, PTH2R, RPL7A, KCNH2, RPS6, BLVRB, FAM178B, KEL, ZNF385D, GATA1 </span></span>
<span><span class="co">#&gt;     ADAMTS3, SLC40A1, RPS5, EEF1B2, RPS3A, RPL13A, CSF1, RPL8, CNRIP1, HBD </span></span>
<span><span class="co">#&gt; PC_ 3 </span></span>
<span><span class="co">#&gt; Positive:  CD74, HLA-DRA, HLA-DRB1, FAM160A1, ACTG1, JCHAIN, EEF1A1, HLA-DPA1, ARL4C, TGFBI </span></span>
<span><span class="co">#&gt;     BLNK, TMSB4X, SPIB, PLXNA4, RPL13A, LGMN, CORO1A, RPS5, SCT, RPS3 </span></span>
<span><span class="co">#&gt;     RNASE6, RPS3A, LIME1, CUX2, ADAM19, PLD4, CST3, IRF7, CARD11, RPL28 </span></span>
<span><span class="co">#&gt; Negative:  AZU1, FNDC3B, ELANE, MPO, LRMDA, PRTN3, KCNQ5, LYST, AFF2, SLC22A15 </span></span>
<span><span class="co">#&gt;     F13A1, EREG, CFD, PLPPR3, ATP8B4, ZEB2, PCBP3, PDE3B, IL1RAP, ACSM3 </span></span>
<span><span class="co">#&gt;     ZNF804A, CSF3R, SLC39A11, PLD1, DENND4A, ANXA1, CTSG, RREB1, TFRC, DGKG </span></span>
<span><span class="co">#&gt; PC_ 4 </span></span>
<span><span class="co">#&gt; Positive:  SPINK2, CALN1, PLCB1, INPP4B, NKAIN2, ANGPT1, ATP8B4, CHRM3, MEIS1, DIAPH3 </span></span>
<span><span class="co">#&gt;     PHGDH, MIR924HG, SMIM24, MDK, TOP2A, CSF3R, ASPM, C1QTNF4, KIF15, TYMS </span></span>
<span><span class="co">#&gt;     PRKCH, NUSAP1, TUBA1B, RRM2, CIT, TK1, CDCA5, POLQ, NDC80, AURKB </span></span>
<span><span class="co">#&gt; Negative:  SAMHD1, CD36, SULF2, ANK1, FAM160A1, TGFBI, CST3, RYR3, RAB11FIP1, S100A6 </span></span>
<span><span class="co">#&gt;     APOC1, XACT, IRF8, RNASE6, FCER1G, PLXNA4, LYZ, CPB1, APOE, UGCG </span></span>
<span><span class="co">#&gt;     FAM178B, GPR183, CSF2RB, RBM47, PIK3R5, MPEG1, CUX2, MICAL2, SLC8A1, CYBB </span></span>
<span><span class="co">#&gt; PC_ 5 </span></span>
<span><span class="co">#&gt; Positive:  MECOM, PCDH9, PRKG1, ASPM, PLXDC2, THRB, SKAP1, PHTF1, ZNF385D, PRKG2 </span></span>
<span><span class="co">#&gt;     SETBP1, PBX1, GPC5, LIMCH1, TOP2A, MED12L, MKI67, GTSE1, ELL2, PTK2 </span></span>
<span><span class="co">#&gt;     PREX2, CENPE, AURKB, CRHBP, DNM3, KIF18B, NUSAP1, HLF, CIT, DIAPH3 </span></span>
<span><span class="co">#&gt; Negative:  GAPDH, RPS19, IGLL1, RPLP0, C1QTNF4, RPL28, RPL13A, RPL18A, RPS24, EEF1A1 </span></span>
<span><span class="co">#&gt;     GYPC, PRSS57, RPLP2, SMIM24, RPS8, RPL35, MIR181A1HG, RPS3, RPL27A, RPL14 </span></span>
<span><span class="co">#&gt;     RPL7, RPS6, RPL6, RPL8, RPL32, RACK1, ACTG1, RPL29, RPS3A, RPL7A</span></span>
<span><span class="va">cd34.singlecells</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/RunUMAP.html">RunUMAP</a></span><span class="op">(</span><span class="va">cd34.singlecells</span>,dims <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">50</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; 15:31:32 UMAP embedding parameters a = 0.9922 b = 1.112</span></span>
<span><span class="co">#&gt; 15:31:32 Read 6881 rows and found 50 numeric columns</span></span>
<span><span class="co">#&gt; 15:31:32 Using Annoy for neighbor search, n_neighbors = 30</span></span>
<span><span class="co">#&gt; 15:31:32 Building Annoy index with metric = cosine, n_trees = 50</span></span>
<span><span class="co">#&gt; 0%   10   20   30   40   50   60   70   80   90   100%</span></span>
<span><span class="co">#&gt; [----|----|----|----|----|----|----|----|----|----|</span></span>
<span><span class="co">#&gt; **************************************************|</span></span>
<span><span class="co">#&gt; 15:31:32 Writing NN index file to temp file /tmp/35398939/RtmpceShhA/file2a870e5913162a</span></span>
<span><span class="co">#&gt; 15:31:32 Searching Annoy index using 1 thread, search_k = 3000</span></span>
<span><span class="co">#&gt; 15:31:34 Annoy recall = 100%</span></span>
<span><span class="co">#&gt; 15:31:34 Commencing smooth kNN distance calibration using 1 thread with target n_neighbors = 30</span></span>
<span><span class="co">#&gt; 15:31:35 Initializing from normalized Laplacian + noise (using irlba)</span></span>
<span><span class="co">#&gt; 15:31:35 Commencing optimization for 500 epochs, with 293954 positive edges</span></span>
<span><span class="co">#&gt; 15:31:43 Optimization finished</span></span></code></pre></div>
<p>Plot single cell data.</p>
<div class="sourceCode" id="cb103"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://satijalab.org/seurat/reference/DimPlot.html">UMAPPlot</a></span><span class="op">(</span><span class="va">cd34.singlecells</span>,group.by <span class="op">=</span> <span class="st">"celltype"</span>,label <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure">
<img src="23-downstream_continuous_files/figure-html/unnamed-chunk-21-1.png" width="672">
### Visualization of metacells in single-cell space</div>
<p>Now we can plot metacells from MetaCell2 in the single-cell space.</p>
<div class="sourceCode" id="cb104"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/MetacellAnalysisToolkit/man/mc_projection.html">mc_projection</a></span><span class="op">(</span></span>
<span>  sc.obj <span class="op">=</span> <span class="va">cd34.singlecells</span>,</span>
<span>  mc.obj <span class="op">=</span> <span class="va">cd34.metacell</span>,</span>
<span>  cell.membership <span class="op">=</span> <span class="va">cd34.metacell</span><span class="op">@</span><span class="va">misc</span><span class="op">$</span><span class="va">membership</span>,</span>
<span>  sc.reduction <span class="op">=</span> <span class="st">"umap"</span>,</span>
<span>  sc.label <span class="op">=</span> <span class="st">"celltype"</span>, <span class="co"># single cells will be colored according the sc.label</span></span>
<span>  metacell.label <span class="op">=</span> <span class="st">"celltype"</span> <span class="co"># metacells cell will be colored according the metacell.label</span></span>
<span>  <span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_classic</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="23-downstream_continuous_files/figure-html/unnamed-chunk-22-1.png" width="672"></div>
<p>And same for metacells obtained with SuperCell.</p>
<div class="sourceCode" id="cb105"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/MetacellAnalysisToolkit/man/mc_projection.html">mc_projection</a></span><span class="op">(</span></span>
<span>  sc.obj <span class="op">=</span> <span class="va">cd34.singlecells</span>,</span>
<span>  mc.obj <span class="op">=</span> <span class="va">cd34.supercell</span>,</span>
<span>  cell.membership <span class="op">=</span> <span class="va">cd34.supercell</span><span class="op">@</span><span class="va">misc</span><span class="op">$</span><span class="va">cell_membership</span>,</span>
<span>  sc.reduction <span class="op">=</span> <span class="st">"umap"</span>,</span>
<span>  sc.label <span class="op">=</span> <span class="st">"celltype"</span>, <span class="co"># single cells will be colored according the sc.label</span></span>
<span>  metacell.label <span class="op">=</span> <span class="st">"celltype"</span> <span class="co"># metacells cell will be colored according the metacell.label</span></span>
<span>  <span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_classic</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure">
<img src="23-downstream_continuous_files/figure-html/unnamed-chunk-23-1.png" width="672">
### Compactness and separation</div>
<p>We can compute the compactness and separation of the metacells from the single cell pca.
With the <code>mc_compactnness</code> we can use the approach of SEACells by computing these metrics in a diffusion map obtained from the pca.</p>
<p>First for MetaCell2 metacells</p>
<div class="sourceCode" id="cb106"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cd34.metacell</span><span class="op">$</span><span class="va">compactness</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/MetacellAnalysisToolkit/man/mc_compactness.html">mc_compactness</a></span><span class="op">(</span>cell.membership <span class="op">=</span> <span class="va">cd34.metacell</span><span class="op">@</span><span class="va">misc</span><span class="op">$</span><span class="va">cell_membership</span>, sc.obj <span class="op">=</span> <span class="va">cd34.singlecells</span>,</span>
<span>                                      sc.reduction <span class="op">=</span> <span class="st">"pca"</span>, n.components <span class="op">=</span> <span class="fl">50</span>, diffusion.components <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="co">#&gt; Computing compactness ...</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/MetacellAnalysisToolkit/man/qc_boxplot.html">qc_boxplot</a></span><span class="op">(</span>mc.obj <span class="op">=</span> <span class="va">cd34.metacell</span>, qc.metrics <span class="op">=</span> <span class="st">"compactness"</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="23-downstream_continuous_files/figure-html/unnamed-chunk-24-1.png" width="672"></div>
<div class="sourceCode" id="cb107"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cd34.metacell</span><span class="op">$</span><span class="va">separation</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/MetacellAnalysisToolkit/man/mc_separation.html">mc_separation</a></span><span class="op">(</span>cell.membership <span class="op">=</span> <span class="va">cd34.metacell</span><span class="op">@</span><span class="va">misc</span><span class="op">$</span><span class="va">cell_membership</span>, sc.obj <span class="op">=</span> <span class="va">cd34.singlecells</span>,</span>
<span>                                      sc.reduction <span class="op">=</span> <span class="st">"pca"</span>, n.components <span class="op">=</span> <span class="fl">50</span>, diffusion.components <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="co">#&gt; Computing separation ...</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/MetacellAnalysisToolkit/man/qc_boxplot.html">qc_boxplot</a></span><span class="op">(</span>mc.obj <span class="op">=</span> <span class="va">cd34.metacell</span>, qc.metrics <span class="op">=</span> <span class="st">"separation"</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure">
<img src="23-downstream_continuous_files/figure-html/unnamed-chunk-25-1.png" width="672">
Same for metacell obtained with SuperCell.</div>
<div class="sourceCode" id="cb108"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cd34.supercell</span><span class="op">$</span><span class="va">compactness</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/MetacellAnalysisToolkit/man/mc_compactness.html">mc_compactness</a></span><span class="op">(</span>cell.membership <span class="op">=</span> <span class="va">cd34.supercell</span><span class="op">@</span><span class="va">misc</span><span class="op">$</span><span class="va">cell_membership</span>, sc.obj <span class="op">=</span> <span class="va">cd34.singlecells</span>,</span>
<span>                                      sc.reduction <span class="op">=</span> <span class="st">"pca"</span>, n.components <span class="op">=</span> <span class="fl">50</span>, diffusion.components <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="co">#&gt; Computing compactness ...</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/MetacellAnalysisToolkit/man/qc_boxplot.html">qc_boxplot</a></span><span class="op">(</span>mc.obj <span class="op">=</span> <span class="va">cd34.supercell</span>, qc.metrics <span class="op">=</span> <span class="st">"compactness"</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="23-downstream_continuous_files/figure-html/unnamed-chunk-26-1.png" width="672"></div>
<div class="sourceCode" id="cb109"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cd34.supercell</span><span class="op">$</span><span class="va">separation</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/MetacellAnalysisToolkit/man/mc_separation.html">mc_separation</a></span><span class="op">(</span>cell.membership <span class="op">=</span> <span class="va">cd34.supercell</span><span class="op">@</span><span class="va">misc</span><span class="op">$</span><span class="va">cell_membership</span>, sc.obj <span class="op">=</span> <span class="va">cd34.singlecells</span>,</span>
<span>                                      sc.reduction <span class="op">=</span> <span class="st">"pca"</span>, n.components <span class="op">=</span> <span class="fl">50</span>, diffusion.components <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="co">#&gt; Computing separation ...</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/MetacellAnalysisToolkit/man/qc_boxplot.html">qc_boxplot</a></span><span class="op">(</span>mc.obj <span class="op">=</span> <span class="va">cd34.supercell</span>, qc.metrics <span class="op">=</span> <span class="st">"separation"</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure">
<img src="23-downstream_continuous_files/figure-html/unnamed-chunk-27-1.png" width="672">
### Inner normalized variance (INV)
We can compute the INV for the MetaCell2 and SuperCell metacells as defined in MetaCell paper.</div>
<div class="sourceCode" id="cb110"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cd34.supercell</span><span class="op">$</span><span class="va">INV</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/MetacellAnalysisToolkit/man/mc_INV.html">mc_INV</a></span><span class="op">(</span>cell.membership <span class="op">=</span> <span class="va">cd34.supercell</span><span class="op">@</span><span class="va">misc</span><span class="op">$</span><span class="va">cell_membership</span>, sc.obj <span class="op">=</span> <span class="va">cd34.singlecells</span><span class="op">)</span></span>
<span><span class="co">#&gt; Computing INV ...</span></span>
<span><span class="va">cd34.metacell</span><span class="op">$</span><span class="va">INV</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/MetacellAnalysisToolkit/man/mc_INV.html">mc_INV</a></span><span class="op">(</span>cell.membership <span class="op">=</span> <span class="va">cd34.metacell</span><span class="op">@</span><span class="va">misc</span><span class="op">$</span><span class="va">cell_membership</span>, sc.obj <span class="op">=</span> <span class="va">cd34.singlecells</span><span class="op">)</span></span>
<span><span class="co">#&gt; Computing INV ...</span></span></code></pre></div>
<p>Comparison of MetaCell2 and SuperCell for compactness (lower the better).</p>
<div class="sourceCode" id="cb111"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cd34.metacell</span><span class="op">$</span><span class="va">tool</span> <span class="op">&lt;-</span> <span class="st">"MetaCell2"</span></span>
<span><span class="va">cd34.supercell</span><span class="op">$</span><span class="va">tool</span> <span class="op">&lt;-</span> <span class="st">"SuperCell"</span></span>
<span><span class="va">data.metrics</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">cd34.metacell</span><span class="op">@</span><span class="va">meta.data</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"tool"</span>,<span class="st">"INV"</span>,<span class="st">"compactness"</span>,<span class="st">"separation"</span><span class="op">)</span><span class="op">]</span>,</span>
<span>                      <span class="va">cd34.supercell</span><span class="op">@</span><span class="va">meta.data</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"tool"</span>,<span class="st">"INV"</span>,<span class="st">"compactness"</span>,<span class="st">"separation"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">data.metrics</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">compactness</span>,x<span class="op">=</span><span class="va">tool</span>,fill <span class="op">=</span> <span class="va">tool</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html">geom_boxplot</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure">
<img src="23-downstream_continuous_files/figure-html/unnamed-chunk-29-1.png" width="672">
Comparison of MetaCell2 and SuperCell for separation (higher the better).</div>
<div class="sourceCode" id="cb112"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">data.metrics</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">separation</span>,x<span class="op">=</span><span class="va">tool</span>,fill <span class="op">=</span> <span class="va">tool</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html">geom_boxplot</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="23-downstream_continuous_files/figure-html/unnamed-chunk-30-1.png" width="672"></div>
<p>Comparison of MetaCell2 and SuperCell for INV (lower the better).</p>
<div class="sourceCode" id="cb113"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">data.metrics</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">INV</span>,x<span class="op">=</span><span class="va">tool</span>,fill <span class="op">=</span> <span class="va">tool</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html">geom_boxplot</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="23-downstream_continuous_files/figure-html/unnamed-chunk-31-1.png" width="672"></div>

</div>
</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="QCs.html"><span class="header-section-number">4</span> Metacells QCs</a></div>
<div class="next"><a href="downstream-analysis-of-metacells.html"><span class="header-section-number">6</span> Downstream analysis of metacells</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#command-line"><span class="header-section-number">5</span> Metacell Analysis Toolkit (MCAT)</a></li>
<li><a class="nav-link" href="#setting-up-the-environment"><span class="header-section-number">5.1</span> Setting up the environment</a></li>
<li>
<a class="nav-link" href="#metacell-building"><span class="header-section-number">5.2</span> Metacell building</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#building-metacell-with-metacell2-mc2"><span class="header-section-number">5.2.1</span> Building metacell with MetaCell2 (MC2)</a></li>
<li><a class="nav-link" href="#building-metacell-with-supercell"><span class="header-section-number">5.2.2</span> Building metacell with SuperCell</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#short-downstream-analysis-of-the-metacells"><span class="header-section-number">5.3</span> Short downstream analysis of the metacells</a><ul class="nav navbar-nav"><li><a class="nav-link" href="#metacell2-metacells"><span class="header-section-number">5.3.1</span> MetaCell2 metacells</a></li></ul>
</li>
<li>
<a class="nav-link" href="#qc-with-the-metacellanalysistoolkit-package"><span class="header-section-number">5.4</span> QC with the MetacellAnalysisToolkit package</a><ul class="nav navbar-nav"><li><a class="nav-link" href="#loading-single-cell-data"><span class="header-section-number">5.4.1</span> Loading single-cell data</a></li></ul>
</li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/GfellerLab/MetacellAnalysisTutorial/blob/main/23-downstream_continuous.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/GfellerLab/MetacellAnalysisTutorial/edit/main/23-downstream_continuous.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Metacell Analysis Tutorial</strong>" was written by Aurélie Gabriel, Léonard Hérault, Mariia Bilous, David Gfeller. It was last built on 2023-11-21.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer>
</body>
</html>
