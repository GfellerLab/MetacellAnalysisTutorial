<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 7 Integration of metacells | Metacell Analysis Tutorial</title>
<meta name="author" content="Aurélie Gabriel, Léonard Hérault, Mariia Bilous, David Gfeller">
<meta name="description" content="In this section, we will work with the Human Cell Lung Atlas core HLCA gathering around 580,000 cells from 107 individuals distributed in 166 samples. The aim of this tutorial is to show how you...">
<meta name="generator" content="bookdown 0.36 with bs4_book()">
<meta property="og:title" content="Chapter 7 Integration of metacells | Metacell Analysis Tutorial">
<meta property="og:type" content="book">
<meta property="og:url" content="https://GfellerLab.github.io/MetacellAnalysisTutorial/integration.html">
<meta property="og:description" content="In this section, we will work with the Human Cell Lung Atlas core HLCA gathering around 580,000 cells from 107 individuals distributed in 166 samples. The aim of this tutorial is to show how you...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 7 Integration of metacells | Metacell Analysis Tutorial">
<meta name="twitter:description" content="In this section, we will work with the Human Cell Lung Atlas core HLCA gathering around 580,000 cells from 107 individuals distributed in 166 samples. The aim of this tutorial is to show how you...">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.5.0/transition.js"></script><script src="libs/bs3compat-0.5.0/tabs.js"></script><script src="libs/bs3compat-0.5.0/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<style type="text/css">
    /* Used with Pandoc 2.11+ new --citeproc when CSL is used */
    div.csl-bib-body { }
    div.csl-entry {
      clear: both;
        }
    .hanging div.csl-entry {
      margin-left:2em;
      text-indent:-2em;
    }
    div.csl-left-margin {
      min-width:2em;
      float:left;
    }
    div.csl-right-inline {
      margin-left:2em;
      padding-left:1em;
    }
    div.csl-indent {
      margin-left: 2em;
    }
  </style>
<link rel="stylesheet" href="style.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Metacell Analysis Tutorial</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">This tutorial</a></li>
<li><a class="" href="requirements.html"><span class="header-section-number">1</span> Requirements</a></li>
<li><a class="" href="the-metacell-concept.html"><span class="header-section-number">2</span> The metacell concept</a></li>
<li><a class="" href="Metacell-construction-chapter.html"><span class="header-section-number">3</span> Constructing metacells</a></li>
<li><a class="" href="QCs.html"><span class="header-section-number">4</span> Metacells QCs</a></li>
<li><a class="" href="downstream-analysis.html"><span class="header-section-number">5</span> Downstream analysis of metacells</a></li>
<li><a class="" href="command-line.html"><span class="header-section-number">6</span> Metacell Analysis Toolkit (MCAT)</a></li>
<li><a class="active" href="integration.html"><span class="header-section-number">7</span> Integration of metacells</a></li>
<li><a class="" href="references.html">References</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/GfellerLab/MetacellAnalysisTutorial">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="integration" class="section level1" number="7">
<h1>
<span class="header-section-number">7</span> Integration of metacells<a class="anchor" aria-label="anchor" href="#integration"><i class="fas fa-link"></i></a>
</h1>
<p>In this section, we will work with the Human Cell Lung Atlas core <a href="https://www.nature.com/articles/s41591-023-02327-2">HLCA</a>
gathering around 580,000 cells from 107 individuals distributed in 166 samples.</p>
<p>The aim of this tutorial is to show how you can use metacells to analyze a very large dataset using a reasonable amount of time and memory.
For this we will use here <strong>SuperCell</strong> via the <strong>MCAT</strong> command line tool.</p>
<div id="integration_unsupervised" class="section level2" number="7.1">
<h2>
<span class="header-section-number">7.1</span> Unsupervised integration<a class="anchor" aria-label="anchor" href="#integration_unsupervised"><i class="fas fa-link"></i></a>
</h2>
<p>In this section, we will first perform the integration in an unsupervised mode, i.e., without considering the single-cell annotation.
For a supervised version, please refer to section @ref(integration_supervised).</p>
<div id="data-loading-3" class="section level3" number="7.1.1">
<h3>
<span class="header-section-number">7.1.1</span> Data loading<a class="anchor" aria-label="anchor" href="#data-loading-3"><i class="fas fa-link"></i></a>
</h3>
<p>Please follow the section <a href="requirements.html#HLCA-data">1.4</a> to retrieve the HLCA atlas, divide the atlas by dataset and save the splitted data in the following folder: “data/HLCA/”.</p>
</div>
<div id="setting-up-the-environment-1" class="section level3" number="7.1.2">
<h3>
<span class="header-section-number">7.1.2</span> Setting up the environment<a class="anchor" aria-label="anchor" href="#setting-up-the-environment-1"><i class="fas fa-link"></i></a>
</h3>
<p>First we need to specify that we will work with the MetacellAnalysisToolkit conda environment (needed for anndata relying on reticulate and the MCAT tool).
To build the conda environment please follow the instructions on our MetacellAnalysisToolkit <a href="https://github.com/GfellerLab/MetacellToolkit">github repository</a>.</p>
<div class="sourceCode" id="cb133"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rstudio.github.io/reticulate/">reticulate</a></span><span class="op">)</span></span>
<span><span class="va">conda_env</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://rstudio.github.io/reticulate/reference/conda-tools.html">conda_list</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="fu">reticulate</span><span class="fu">::</span><span class="fu"><a href="https://rstudio.github.io/reticulate/reference/conda-tools.html">conda_list</a></span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="va">name</span> <span class="op">==</span> <span class="st">"MetacellAnalysisToolkit"</span>,<span class="st">"python"</span><span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Sys.setenv.html">Sys.setenv</a></span><span class="op">(</span>RETICULATE_PYTHON <span class="op">=</span> <span class="va">conda_env</span><span class="op">)</span></span></code></pre></div>
<pre><code>#&gt;           used (Mb) gc trigger (Mb) max used (Mb)
#&gt; Ncells  649426 34.7    1512985 80.9   704592 37.7
#&gt; Vcells 1197064  9.2    8388608 64.0  1814779 13.9</code></pre>
<div class="sourceCode" id="cb135"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://satijalab.org/seurat">Seurat</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; The legacy packages maptools, rgdal, and rgeos, underpinning this package</span></span>
<span><span class="co">#&gt; will retire shortly. Please refer to R-spatial evolution reports on</span></span>
<span><span class="co">#&gt; https://r-spatial.org/r/2023/05/15/evolution4.html for details.</span></span>
<span><span class="co">#&gt; This package is now running under evolution status 0</span></span>
<span><span class="co">#&gt; Attaching SeuratObject</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://anndata.dynverse.org">anndata</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">SuperCell</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">color.celltypes</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'#E5D2DD'</span>, <span class="st">'#53A85F'</span>, <span class="st">'#F1BB72'</span>, <span class="st">'#F3B1A0'</span>, <span class="st">'#D6E7A3'</span>, <span class="st">'#57C3F3'</span>, <span class="st">'#476D87'</span>,</span>
<span>                      <span class="st">'#E95C59'</span>, <span class="st">'#E59CC4'</span>, <span class="st">'#AB3282'</span>, <span class="st">'#23452F'</span>, <span class="st">'#BD956A'</span>, <span class="st">'#8C549C'</span>, <span class="st">'#585658'</span>,</span>
<span>                      <span class="st">'#9FA3A8'</span>, <span class="st">'#E0D4CA'</span>, <span class="st">'#5F3D69'</span>, <span class="st">'#58A4C3'</span>, <span class="st">"#b20000"</span>,<span class="st">'#E4C755'</span>, <span class="st">'#F7F398'</span>,</span>
<span>                      <span class="st">'#AA9A59'</span>, <span class="st">'#E63863'</span>, <span class="st">'#E39A35'</span>, <span class="st">'#C1E6F3'</span>, <span class="st">'#6778AE'</span>, <span class="st">'#91D0BE'</span>, <span class="st">'#B53E2B'</span>,</span>
<span>                      <span class="st">'#712820'</span>, <span class="st">'#DCC1DD'</span>, <span class="st">'#CCE0F5'</span>, <span class="st">'#CCC9E6'</span>, <span class="st">'#625D9E'</span>, <span class="st">'#68A180'</span>, <span class="st">'#3A6963'</span>,</span>
<span>                      <span class="st">'#968175'</span><span class="op">)</span></span></code></pre></div>
</div>
<div id="building-metacell" class="section level3" number="7.1.3">
<h3>
<span class="header-section-number">7.1.3</span> Building metacell<a class="anchor" aria-label="anchor" href="#building-metacell"><i class="fas fa-link"></i></a>
</h3>
<p>We build metacells with the MCAT command line using SuperCell (<code>-t SuperCell</code>).
To facilitate downstream analysis of the donors we build metacells for each sample in each dataset (<code>-a sample</code>).
Here we will use 2000 highly variable genes (<code>-f 2000</code>) to compute the PCA from which we used 50 principal components (<code>-m 50</code>) to build a k = 30 (<code>-k 30</code>) nearest neighbor graph on which the metacells are identified using a graining level of 50 (<code>-g 50</code>).
We use an adata .h5ad output format (<code>-s adata</code>) as it is faster to write and lighter to store than a Seurat .rds object.</p>
<p>This step takes around 20 min with multiple cores (<code>-l 6</code>). Be aware that parallel processing requires more memory (32 GB of memory required for 6 cores).</p>
<p>If you are limited in memory you should still be able to process the samples by reducing the number of cores (e.g. <code>-l 3</code>) or
by sequentially processing the samples (just remove the <code>-l</code>) in a slightly longer time.</p>
<p>To call the MCAT command line, please define your path to the gihub cloned repository optained from this <a href="https://github.com/GfellerLab/MetacellToolkit">github repository</a>.</p>
<div class="sourceCode" id="cb136"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb136-1"><a href="integration.html#cb136-1" aria-hidden="true" tabindex="-1"></a><span class="co">#git clone https://github.com/GfellerLab/MetacellAnalysisToolkit</span></span>
<span id="cb136-2"><a href="integration.html#cb136-2" aria-hidden="true" tabindex="-1"></a><span class="va">MCAT_path</span><span class="op">=</span>MetacellAnalysisToolkit/</span>
<span id="cb136-3"><a href="integration.html#cb136-3" aria-hidden="true" tabindex="-1"></a><span class="va">start</span><span class="op">=</span><span class="kw">`</span><span class="fu">date</span> +%s<span class="kw">`</span></span>
<span id="cb136-4"><a href="integration.html#cb136-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> d <span class="kw">in</span> data/HLCA/datasets/<span class="pp">*</span><span class="kw">;</span></span>
<span id="cb136-5"><a href="integration.html#cb136-5" aria-hidden="true" tabindex="-1"></a><span class="cf">do</span> <span class="va">${MCAT_path}</span><span class="ex">cli/MCAT</span> <span class="at">-t</span> SuperCell <span class="at">-i</span> <span class="va">$d</span>/sc_adata.h5ad <span class="at">-o</span> <span class="va">$d</span> <span class="at">-a</span> sample <span class="at">-l</span> 3 <span class="at">-n</span> 50 <span class="at">-f</span> 2000 <span class="at">-k</span> 30 <span class="at">-g</span> 50 <span class="at">-s</span> adata</span>
<span id="cb136-6"><a href="integration.html#cb136-6" aria-hidden="true" tabindex="-1"></a><span class="cf">done</span></span>
<span id="cb136-7"><a href="integration.html#cb136-7" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"Duration: </span><span class="va">$((</span>(<span class="va">$(</span><span class="fu">date</span> +%s<span class="va">)</span><span class="op">-</span><span class="va">$start</span>)<span class="op">/</span><span class="dv">60</span><span class="va">))</span><span class="st"> minutes"</span></span></code></pre></div>
</div>
<div id="loading-metacell-objects" class="section level3" number="7.1.4">
<h3>
<span class="header-section-number">7.1.4</span> Loading metacell objects<a class="anchor" aria-label="anchor" href="#loading-metacell-objects"><i class="fas fa-link"></i></a>
</h3>
<p>We load the .h5ad objects and directly convert them in Seurat objects to benefit from all the functions of this framework.
To consider the datasets in the same order as the one used in this tutorial we run the following chunk before loading the metacell objects.</p>
<div class="sourceCode" id="cb137"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://anndata.dynverse.org">anndata</a></span><span class="op">)</span></span>
<span><span class="va">adata</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://anndata.dynverse.org/reference/read_h5ad.html">read_h5ad</a></span><span class="op">(</span><span class="st">"data/HLCA/local.h5ad"</span>,backed <span class="op">=</span> <span class="st">"r"</span><span class="op">)</span></span>
<span><span class="va">adata</span><span class="op">$</span><span class="va">var_names</span> <span class="op">&lt;-</span> <span class="va">adata</span><span class="op">$</span><span class="va">var</span><span class="op">$</span><span class="va">feature_name</span> <span class="co"># We will use gene short name for downstream analyses</span></span>
<span><span class="va">datasets</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">adata</span><span class="op">$</span><span class="va">obs</span><span class="op">$</span><span class="va">dat</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span><span class="op">(</span><span class="va">adata</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/gc.html">gc</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb138"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">metacell.files</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">datasets</span>, FUN <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"data/HLCA/datasets/"</span>,<span class="va">x</span>,<span class="st">"/mc_adata.h5ad"</span><span class="op">)</span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="va">metacell.objs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">metacell.files</span>, <span class="kw">function</span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">adata</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://anndata.dynverse.org/reference/read_h5ad.html">read_h5ad</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span></span>
<span>  <span class="va">countMatrix</span> <span class="op">&lt;-</span> <span class="fu">Matrix</span><span class="fu">::</span><span class="fu">t</span><span class="op">(</span><span class="va">adata</span><span class="op">$</span><span class="va">X</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">countMatrix</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">adata</span><span class="op">$</span><span class="va">obs_names</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">countMatrix</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">adata</span><span class="op">$</span><span class="va">var_names</span></span>
<span>  <span class="va">sobj</span> <span class="op">&lt;-</span> <span class="fu">Seurat</span><span class="fu">::</span><span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/CreateSeuratObject.html">CreateSeuratObject</a></span><span class="op">(</span>counts <span class="op">=</span> <span class="va">countMatrix</span>,meta.data <span class="op">=</span> <span class="va">adata</span><span class="op">$</span><span class="va">obs</span><span class="op">)</span></span>
<span>  <span class="va">sobj</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/RenameCells.html">RenameCells</a></span><span class="op">(</span><span class="va">sobj</span>, add.cell.id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">sobj</span><span class="op">$</span><span class="va">sample</span><span class="op">)</span><span class="op">)</span> <span class="co"># we give unique name to metacells</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">sobj</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
</div>
<div id="merging-objects-and-basic-quality-control" class="section level3" number="7.1.5">
<h3>
<span class="header-section-number">7.1.5</span> Merging objects and basic quality control<a class="anchor" aria-label="anchor" href="#merging-objects-and-basic-quality-control"><i class="fas fa-link"></i></a>
</h3>
<p>Given the single-cell metadata, the MCAT tool automatically assigns annotations to metacells and computes purities for all the categorical variables present
in the metadata of the input single-cell object.</p>
<p>Thus, we can check the purity of our metacells at different levels of annotations, as well as their size (number of single cells they contain).</p>
<p>To do so we merge the object together and use the Seurat <code>VlnPlot</code> function.</p>
<div class="sourceCode" id="cb139"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">unintegrated.mc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html">merge</a></span><span class="op">(</span><span class="va">metacell.objs</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="va">metacell.objs</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://satijalab.org/seurat/reference/VlnPlot.html">VlnPlot</a></span><span class="op">(</span><span class="va">unintegrated.mc</span>, features <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"size"</span>, <span class="st">"ann_level_1_purity"</span><span class="op">)</span>, group.by <span class="op">=</span> <span class="st">'dataset'</span>, pt.size <span class="op">=</span> <span class="fl">0.001</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="40-integration_analysis_files/figure-html/unintegrated_vlnPlot_obj-1.png" width="672"></div>
<div class="sourceCode" id="cb140"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://satijalab.org/seurat/reference/VlnPlot.html">VlnPlot</a></span><span class="op">(</span><span class="va">unintegrated.mc</span>, features <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"ann_level_2_purity"</span>, <span class="st">"ann_level_3_purity"</span><span class="op">)</span>, group.by <span class="op">=</span> <span class="st">'dataset'</span>, pt.size <span class="op">=</span> <span class="fl">0.001</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="40-integration_analysis_files/figure-html/unintegrated_vlnPlot_obj-2.png" width="672"></div>
<p>We can also use box plots.</p>
<div class="sourceCode" id="cb141"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">unintegrated.mc</span><span class="op">@</span><span class="va">meta.data</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">dataset</span>, y <span class="op">=</span> <span class="va">ann_level_2_purity</span>, fill <span class="op">=</span> <span class="va">dataset</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html">geom_boxplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_discrete.html">scale_x_discrete</a></span><span class="op">(</span>guide <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_axis.html">guide_axis</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">45</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="40-integration_analysis_files/figure-html/unintegrated_boxplot_obj-1.png" width="672"></div>
<div class="sourceCode" id="cb142"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">unintegrated.mc</span><span class="op">@</span><span class="va">meta.data</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">dataset</span>, y <span class="op">=</span> <span class="va">ann_level_3_purity</span>, fill <span class="op">=</span> <span class="va">dataset</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html">geom_boxplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_discrete.html">scale_x_discrete</a></span><span class="op">(</span>guide <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_axis.html">guide_axis</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">45</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="40-integration_analysis_files/figure-html/unintegrated_boxplot_obj-2.png" width="672"></div>
<div class="sourceCode" id="cb143"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">unintegrated.mc</span><span class="op">@</span><span class="va">meta.data</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">dataset</span>, y <span class="op">=</span> <span class="va">ann_level_4_purity</span>, fill <span class="op">=</span> <span class="va">dataset</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html">geom_boxplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_discrete.html">scale_x_discrete</a></span><span class="op">(</span>guide <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_axis.html">guide_axis</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">45</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="40-integration_analysis_files/figure-html/unintegrated_boxplot_obj-3.png" width="672"></div>
<div class="sourceCode" id="cb144"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">unintegrated.mc</span><span class="op">@</span><span class="va">meta.data</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">dataset</span>, y <span class="op">=</span> <span class="va">ann_finest_level_purity</span>, fill <span class="op">=</span> <span class="va">dataset</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html">geom_boxplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_discrete.html">scale_x_discrete</a></span><span class="op">(</span>guide <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_axis.html">guide_axis</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">45</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="40-integration_analysis_files/figure-html/unintegrated_boxplot_obj-4.png" width="672"></div>
<p>Overall metacells from the different datasets present a good purity until the third level of annotation.</p>
</div>
<div id="unintegrated-analysis" class="section level3" number="7.1.6">
<h3>
<span class="header-section-number">7.1.6</span> Unintegrated analysis<a class="anchor" aria-label="anchor" href="#unintegrated-analysis"><i class="fas fa-link"></i></a>
</h3>
<p>Let’s first do a standard dimensionality reduction without batch correction.</p>
<div class="sourceCode" id="cb145"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/DefaultAssay.html">DefaultAssay</a></span><span class="op">(</span><span class="va">unintegrated.mc</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"RNA"</span></span>
<span><span class="va">unintegrated.mc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/NormalizeData.html">NormalizeData</a></span><span class="op">(</span><span class="va">unintegrated.mc</span><span class="op">)</span></span>
<span><span class="va">unintegrated.mc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/FindVariableFeatures.html">FindVariableFeatures</a></span><span class="op">(</span><span class="va">unintegrated.mc</span><span class="op">)</span></span>
<span><span class="va">unintegrated.mc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/ScaleData.html">ScaleData</a></span><span class="op">(</span><span class="va">unintegrated.mc</span><span class="op">)</span></span>
<span><span class="va">unintegrated.mc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/RunPCA.html">RunPCA</a></span><span class="op">(</span><span class="va">unintegrated.mc</span><span class="op">)</span></span>
<span><span class="va">unintegrated.mc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/RunUMAP.html">RunUMAP</a></span><span class="op">(</span><span class="va">unintegrated.mc</span>, dims <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">30</span><span class="op">)</span></span>
<span></span>
<span><span class="va">umap.unintegrated.datasets</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/DimPlot.html">DimPlot</a></span><span class="op">(</span><span class="va">unintegrated.mc</span>,reduction <span class="op">=</span> <span class="st">"umap"</span>,group.by <span class="op">=</span> <span class="st">"dataset"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/SeuratTheme.html">NoLegend</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"unintegrated datasets"</span><span class="op">)</span></span>
<span><span class="va">umap.unintegrated.types</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/DimPlot.html">DimPlot</a></span><span class="op">(</span><span class="va">unintegrated.mc</span>, reduction <span class="op">=</span> <span class="st">"umap"</span>, group.by <span class="op">=</span> <span class="st">"ann_level_2"</span>, label <span class="op">=</span> <span class="cn">T</span>, repel <span class="op">=</span> <span class="cn">T</span>, cols <span class="op">=</span> <span class="va">color.celltypes</span><span class="op">)</span><span class="op">+</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/SeuratTheme.html">NoLegend</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"unintegrated cell types"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">umap.unintegrated.datasets</span> <span class="op">+</span> <span class="va">umap.unintegrated.types</span></span></code></pre></div>
<div class="inline-figure"><img src="40-integration_analysis_files/figure-html/unintegrated_preprocess-1.png" width="672"></div>
<div class="sourceCode" id="cb146"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rm.html">remove</a></span><span class="op">(</span><span class="va">unintegrated.mc</span><span class="op">)</span> <span class="co"># we won't use the unintegrated object anymore</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/gc.html">gc</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>You can see on the plots that a batch effect is clearly present at the metacell level with metacells clustering by datasets inside the major cell types.
Let’s correct it.</p>
</div>
<div id="seurat-integration" class="section level3" number="7.1.7">
<h3>
<span class="header-section-number">7.1.7</span> Seurat integration<a class="anchor" aria-label="anchor" href="#seurat-integration"><i class="fas fa-link"></i></a>
</h3>
<p>Here we will use the standard Seurat_v4 batch correction <a href="https://satijalab.org/seurat/archive/v4.3/integration_rpca">workflow</a>. As in the original study, we use the dataset rather than the donor as the batch parameter.
See method section “Data integration benchmarking” of the <a href="https://www.nature.com/articles/s41591-023-02327-2">original study</a> for more details.</p>
<p>This should take less than 5 minutes.</p>
<div class="sourceCode" id="cb147"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">n.metacells</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">metacell.objs</span>, FUN <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">}</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">n.metacells</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">datasets</span></span>
<span><span class="va">ref.names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort</a></span><span class="op">(</span><span class="va">n.metacells</span>,decreasing <span class="op">=</span> <span class="cn">T</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span></span>
<span><span class="va">ref.index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">datasets</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">ref.names</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># normalize each dataset</span></span>
<span><span class="va">metacell.objs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">metacell.objs</span>, FUN <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/DefaultAssay.html">DefaultAssay</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"RNA"</span>;</span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/RenameCells.html">RenameCells</a></span><span class="op">(</span><span class="va">x</span>, add.cell.id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">sample</span><span class="op">)</span><span class="op">)</span> <span class="co"># we give unique name to metacells</span></span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/NormalizeData.html">NormalizeData</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/FindVariableFeatures.html">FindVariableFeatures</a></span><span class="op">(</span><span class="va">x</span>, selection.method <span class="op">=</span> <span class="st">"vst"</span>, nfeatures <span class="op">=</span> <span class="fl">2000</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="va">features</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/SelectIntegrationFeatures.html">SelectIntegrationFeatures</a></span><span class="op">(</span>object.list <span class="op">=</span> <span class="va">metacell.objs</span><span class="op">)</span></span>
<span></span>
<span><span class="va">metacell.objs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">metacell.objs</span>, FUN <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/ScaleData.html">ScaleData</a></span><span class="op">(</span><span class="va">x</span>, features <span class="op">=</span> <span class="va">features</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>    <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/RunPCA.html">RunPCA</a></span><span class="op">(</span><span class="va">x</span>, features <span class="op">=</span> <span class="va">features</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="va">anchors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/FindIntegrationAnchors.html">FindIntegrationAnchors</a></span><span class="op">(</span>object.list <span class="op">=</span> <span class="va">metacell.objs</span>,</span>
<span>                                       anchor.features <span class="op">=</span> <span class="va">features</span>,</span>
<span>                                       reduction <span class="op">=</span> <span class="st">"rpca"</span>,</span>
<span>                                       reference <span class="op">=</span> <span class="va">ref.index</span>, <span class="co"># the 5 biggest datasets (in term of metacell number) are used as reference</span></span>
<span>                                       dims <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">30</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rm.html">remove</a></span><span class="op">(</span><span class="va">metacell.objs</span><span class="op">)</span> <span class="co"># We don't need the object list anymore</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/gc.html">gc</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">combined.mc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/IntegrateData.html">IntegrateData</a></span><span class="op">(</span>anchorset <span class="op">=</span> <span class="va">anchors</span>,k.weight <span class="op">=</span> <span class="fl">40</span><span class="op">)</span> <span class="co"># we have to update the k.weight parameters because the smallest dataset contain less than 100 metacells</span></span></code></pre></div>
<p>Check the obtained object.</p>
<div class="sourceCode" id="cb148"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">combined.mc</span></span>
<span><span class="co">#&gt; An object of class Seurat </span></span>
<span><span class="co">#&gt; 30024 features across 11706 samples within 2 assays </span></span>
<span><span class="co">#&gt; Active assay: integrated (2000 features, 2000 variable features)</span></span>
<span><span class="co">#&gt;  1 other assay present: RNA</span></span></code></pre></div>
<p>We can verify that the sum of metacell sizes corresponds to the original number of single-cells</p>
<div class="sourceCode" id="cb149"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">combined.mc</span><span class="op">$</span><span class="va">size</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 584944</span></span></code></pre></div>
<p>Seurat returns the slot <code>"integrated"</code> that we can use for the downstream analysis.</p>
<div class="sourceCode" id="cb150"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/DefaultAssay.html">DefaultAssay</a></span><span class="op">(</span><span class="va">combined.mc</span><span class="op">)</span> <span class="op">=</span> <span class="st">"integrated"</span></span>
<span><span class="va">combined.mc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/ScaleData.html">ScaleData</a></span><span class="op">(</span><span class="va">combined.mc</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">combined.mc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/RunPCA.html">RunPCA</a></span><span class="op">(</span><span class="va">combined.mc</span>, npcs <span class="op">=</span> <span class="fl">30</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">combined.mc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/RunUMAP.html">RunUMAP</a></span><span class="op">(</span><span class="va">combined.mc</span>, reduction <span class="op">=</span> <span class="st">"pca"</span>, dims <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">30</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">combined.mc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/RunUMAP.html">RunUMAP</a></span><span class="op">(</span><span class="va">combined.mc</span>, dims <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">30</span>,reduction <span class="op">=</span>  <span class="st">"pca"</span>,reduction.name <span class="op">=</span> <span class="st">"umap"</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>Now we can make the plots and visually compare the results with the unintegrated analysis.</p>
<div class="sourceCode" id="cb151"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">umap.integrated.datasets</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/DimPlot.html">DimPlot</a></span><span class="op">(</span><span class="va">combined.mc</span>,reduction <span class="op">=</span> <span class="st">"umap"</span>,group.by <span class="op">=</span> <span class="st">"dataset"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/SeuratTheme.html">NoLegend</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"integrated datasets"</span><span class="op">)</span></span>
<span><span class="va">umap.integrated.celltypes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/DimPlot.html">DimPlot</a></span><span class="op">(</span><span class="va">combined.mc</span>,reduction <span class="op">=</span> <span class="st">"umap"</span>,group.by <span class="op">=</span> <span class="st">"ann_level_2"</span>,label <span class="op">=</span> <span class="cn">T</span>,repel <span class="op">=</span> <span class="cn">T</span>,cols <span class="op">=</span> <span class="va">color.celltypes</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/SeuratTheme.html">NoLegend</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"integrated cell types"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">umap.integrated.datasets</span> <span class="op">+</span> <span class="va">umap.integrated.celltypes</span> <span class="op">+</span> <span class="va">umap.unintegrated.datasets</span> <span class="op">+</span> <span class="va">umap.unintegrated.types</span></span></code></pre></div>
<div class="inline-figure"><img src="40-integration_analysis_files/figure-html/integrated_umap-1.png" width="1344"></div>
<p>Seurat efficiently corrected the batch effect in the data while keeping the cell type separated, but other batch correction methods such as harmony would have also done the job.</p>
<p>Note that In the original study, datasets were integrated using SCANVI semi-supervised integration using partial annotation obtained for each dataset prior integration.
If you are interested in such supervised approach at the metacell level in R you can have a look to our second example in section @ref(integration_supervised) using the <a href="https://github.com/carmonalab/STACAS">STACAS</a> package.</p>
<p>We can navigate in the different annotation levels.</p>
<div class="sourceCode" id="cb152"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://satijalab.org/seurat/reference/DimPlot.html">DimPlot</a></span><span class="op">(</span><span class="va">combined.mc</span>,group.by <span class="op">=</span> <span class="st">"ann_level_1"</span>,reduction <span class="op">=</span> <span class="st">"umap"</span>,label <span class="op">=</span> <span class="cn">T</span>,repel <span class="op">=</span> <span class="cn">T</span>,cols<span class="op">=</span> <span class="va">color.celltypes</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/SeuratTheme.html">NoLegend</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="40-integration_analysis_files/figure-html/integrated_dimplots-1.png" width="672"></div>
<div class="sourceCode" id="cb153"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="https://satijalab.org/seurat/reference/DimPlot.html">DimPlot</a></span><span class="op">(</span><span class="va">combined.mc</span>,group.by <span class="op">=</span> <span class="st">"ann_level_2"</span>,reduction <span class="op">=</span> <span class="st">"umap"</span>,label <span class="op">=</span> <span class="cn">T</span>,repel <span class="op">=</span> <span class="cn">T</span>,cols<span class="op">=</span> <span class="va">color.celltypes</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/SeuratTheme.html">NoLegend</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="40-integration_analysis_files/figure-html/integrated_dimplots-2.png" width="672"></div>
<div class="sourceCode" id="cb154"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="https://satijalab.org/seurat/reference/DimPlot.html">DimPlot</a></span><span class="op">(</span><span class="va">combined.mc</span>,group.by <span class="op">=</span> <span class="st">"ann_level_3"</span>,reduction <span class="op">=</span> <span class="st">"umap"</span>,label <span class="op">=</span> <span class="cn">T</span>, repel <span class="op">=</span> <span class="cn">T</span>,cols<span class="op">=</span> <span class="va">color.celltypes</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/SeuratTheme.html">NoLegend</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="40-integration_analysis_files/figure-html/integrated_dimplots-3.png" width="672"></div>
</div>
<div id="downstream-analysis-1" class="section level3" number="7.1.8">
<h3>
<span class="header-section-number">7.1.8</span> Downstream analysis<a class="anchor" aria-label="anchor" href="#downstream-analysis-1"><i class="fas fa-link"></i></a>
</h3>
<div id="clustering-2" class="section level4" number="7.1.8.1">
<h4>
<span class="header-section-number">7.1.8.1</span> Clustering<a class="anchor" aria-label="anchor" href="#clustering-2"><i class="fas fa-link"></i></a>
</h4>
<p>We cluster the metacells based on the corrected PCA space by Seurat.</p>
<div class="sourceCode" id="cb155"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/DefaultAssay.html">DefaultAssay</a></span><span class="op">(</span><span class="va">combined.mc</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"integrated"</span></span>
<span><span class="va">combined.mc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/FindNeighbors.html">FindNeighbors</a></span><span class="op">(</span><span class="va">combined.mc</span>, reduction <span class="op">=</span> <span class="st">"pca"</span>, dims <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">30</span><span class="op">)</span></span>
<span><span class="va">combined.mc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/FindClusters.html">FindClusters</a></span><span class="op">(</span><span class="va">combined.mc</span>, resolution <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://satijalab.org/seurat/reference/DimPlot.html">UMAPPlot</a></span><span class="op">(</span><span class="va">combined.mc</span>, label <span class="op">=</span> <span class="cn">T</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/SeuratTheme.html">NoLegend</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="40-integration_analysis_files/figure-html/integrated_clustering-1.png" width="672"></div>
</div>
<div id="deferentially-expressed-gene-deg-analysis." class="section level4" number="7.1.8.2">
<h4>
<span class="header-section-number">7.1.8.2</span> Deferentially expressed gene (DEG) analysis.<a class="anchor" aria-label="anchor" href="#deferentially-expressed-gene-deg-analysis."><i class="fas fa-link"></i></a>
</h4>
<p>Now let’s found the markers of the cluster 23 we’ve just identified.</p>
<div class="sourceCode" id="cb156"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/DefaultAssay.html">DefaultAssay</a></span><span class="op">(</span><span class="va">combined.mc</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"RNA"</span></span>
<span><span class="va">markers23</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/FindMarkers.html">FindMarkers</a></span><span class="op">(</span><span class="va">combined.mc</span>, ident.1 <span class="op">=</span> <span class="fl">23</span>, only.pos <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="co">#&gt; For a more efficient implementation of the Wilcoxon Rank Sum Test,</span></span>
<span><span class="co">#&gt; (default method for FindMarkers) please install the limma package</span></span>
<span><span class="co">#&gt; --------------------------------------------</span></span>
<span><span class="co">#&gt; install.packages('BiocManager')</span></span>
<span><span class="co">#&gt; BiocManager::install('limma')</span></span>
<span><span class="co">#&gt; --------------------------------------------</span></span>
<span><span class="co">#&gt; After installation of limma, Seurat will automatically use the more </span></span>
<span><span class="co">#&gt; efficient implementation (no further action necessary).</span></span>
<span><span class="co">#&gt; This message will be shown once per session</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">markers23</span><span class="op">)</span></span>
<span><span class="co">#&gt;       p_val avg_log2FC pct.1 pct.2 p_val_adj</span></span>
<span><span class="co">#&gt; TCL1A     0  1.3939674 0.695 0.020         0</span></span>
<span><span class="co">#&gt; FCRLA     0  1.0703400 0.962 0.022         0</span></span>
<span><span class="co">#&gt; BLK       0  1.2192942 0.990 0.058         0</span></span>
<span><span class="co">#&gt; FCRL5     0  0.7934100 0.895 0.026         0</span></span>
<span><span class="co">#&gt; PNOC      0  0.5477793 0.924 0.050         0</span></span>
<span><span class="co">#&gt; PAX5      0  0.6089985 0.886 0.024         0</span></span></code></pre></div>
<p>This cluster clearly presents a B cell signature with marker genes such as CD19 and PAX5</p>
<div class="sourceCode" id="cb157"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">genes</span> <span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"CD19"</span>,<span class="st">"PAX5"</span><span class="op">)</span> <span class="co"># knwon B cells markers</span></span>
<span><span class="va">markers23</span><span class="op">[</span><span class="va">genes</span>,<span class="op">]</span></span>
<span><span class="co">#&gt;              p_val avg_log2FC pct.1 pct.2     p_val_adj</span></span>
<span><span class="co">#&gt; CD19 1.599543e-207  1.1037564 0.990 0.114 4.482558e-203</span></span>
<span><span class="co">#&gt; PAX5  0.000000e+00  0.6089985 0.886 0.024  0.000000e+00</span></span>
<span><span class="fu"><a href="https://satijalab.org/seurat/reference/VlnPlot.html">VlnPlot</a></span><span class="op">(</span><span class="va">combined.mc</span>, <span class="va">genes</span>, ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="40-integration_analysis_files/figure-html/integrated_markers_visu-1.png" width="672"></div>
<p>By looking at the metacell annotation (assigned from the original single-cell metadata by MCAT),
we can verify that we correctly retrieved the B cell lineage cluster.</p>
<div class="sourceCode" id="cb158"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://satijalab.org/seurat/reference/DimPlot.html">DimPlot</a></span><span class="op">(</span><span class="va">combined.mc</span><span class="op">[</span>, <span class="va">combined.mc</span><span class="op">$</span><span class="va">integrated_snn_res.0.5</span> <span class="op">==</span> <span class="fl">23</span><span class="op">]</span>,</span>
<span>        group.by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"ann_level_3"</span>, <span class="st">"integrated_snn_res.0.5"</span><span class="op">)</span>,</span>
<span>        ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="40-integration_analysis_files/figure-html/unnamed-chunk-9-1.png" width="768"></div>
</div>
<div id="cell-type-abundances-analyses." class="section level4" number="7.1.8.3">
<h4>
<span class="header-section-number">7.1.8.3</span> Cell type abundances analyses.<a class="anchor" aria-label="anchor" href="#cell-type-abundances-analyses."><i class="fas fa-link"></i></a>
</h4>
<p>We can easily make analysis of cell type abundances for different clinical variables as we construct metacell by sample.
We have to take metacell size into account for these analyses.
For instance we can analyse the proportion of different epithelial cell types depending on the smoking status.</p>
<div class="sourceCode" id="cb159"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/hadley/reshape">reshape2</a></span><span class="op">)</span></span>
<span><span class="va">combined.mc.epith</span> <span class="op">&lt;-</span> <span class="va">combined.mc</span><span class="op">[</span>,<span class="va">combined.mc</span><span class="op">$</span><span class="va">ann_level_1</span> <span class="op">==</span> <span class="st">"Epithelial"</span><span class="op">]</span></span>
<span><span class="co">#combined.metacells$major_type &lt;- droplevels(combined.metacells$major_type)</span></span>
<span><span class="va">smpCounts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span><span class="op">(</span><span class="va">combined.mc.epith</span><span class="op">$</span><span class="va">size</span>, by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>sample <span class="op">=</span> <span class="va">combined.mc.epith</span><span class="op">$</span><span class="va">sample</span>,</span>
<span>                                                        major_type <span class="op">=</span> <span class="va">combined.mc.epith</span><span class="op">$</span><span class="va">ann_level_3</span>,</span>
<span>                                                        smoking_status <span class="op">=</span> <span class="va">combined.mc.epith</span><span class="op">$</span><span class="va">smoking_status</span><span class="op">)</span>,</span>
<span>                                                        FUN<span class="op">=</span><span class="va">sum</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rm.html">remove</a></span><span class="op">(</span><span class="va">combined.mc.epith</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/gc.html">gc</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">smpCounts</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">smoking_status</span>,fill<span class="op">=</span><span class="va">major_type</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span><span class="op">(</span>position <span class="op">=</span> <span class="st">"fill"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="va">color.celltypes</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">"% epithelial cells"</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="40-integration_analysis_files/figure-html/integrated_celltype_abondance-1.png" width="672"></div>
<p>Samples from smokers seem to present more AT2 cells but this quick analysis is for illustrative purposes only.
In practice it’s far more complex to draw conclusion as we should have considered the variations between samples/donors as well as many other technical
(tissue dissociation protocol, tissue sampling method, single-cell platform, … ) and biological (BMI, sex, Age, …) variables.</p>
</div>
</div>
<div id="conclusion" class="section level3" number="7.1.9">
<h3>
<span class="header-section-number">7.1.9</span> Conclusion<a class="anchor" aria-label="anchor" href="#conclusion"><i class="fas fa-link"></i></a>
</h3>
<p>Overall we made a precise simplification of the original atlas using metacells built from each sample separately.
By reducing the size of the original atlas by a factor of 50 we could load the data, make an integration to correct batch effect
and recapitulate the main different cell types using a reasonable amount of time and memory.
In contrast, simply loading the original single-cell data in R using Seurat is extremely time-consuming and challenging even for the most powerful computers.</p>
<p>In this first example we used a fully unsupervised workflow and did not use any prior biological knowledge.
Authors of the original study made a remarkable work annotating the hundreds of thousands cells of the atlas.
In the second example in section @ref(integration_supervised) we propose a supervised workflow using this annotation to guide both the metacell
identification and the batch correction.</p>
<p>We can save the results for comparison with the second example.</p>
<div class="sourceCode" id="cb160"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">combined.mc</span>,<span class="st">"data/HLCA/combined.mc.unsup.rds"</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div id="integration_supervised" class="section level2" number="7.2">
<h2>
<span class="header-section-number">7.2</span> Supervised integration<a class="anchor" aria-label="anchor" href="#integration_supervised"><i class="fas fa-link"></i></a>
</h2>
<p>As for the unsupervised integration example, we will work with the Human Cell Lung Atlas core <a href="%5Bhttps://www.nature.com/articles/s41591-023-02327-2">HLCA</a>
gathering around 580,000 cells from 107 individuals distributed in 166 samples.</p>
<p>Taking advantage of the single-cell annotation of the original study we will build metacells for each cell type in each sample and
guide the integration with the cell type label using <a href="https://github.com/carmonalab/STACAS">STACAS</a>.</p>
<div id="data-loading-4" class="section level3" number="7.2.1">
<h3>
<span class="header-section-number">7.2.1</span> Data loading<a class="anchor" aria-label="anchor" href="#data-loading-4"><i class="fas fa-link"></i></a>
</h3>
<p>Please follow the section <a href="requirements.html#HLCA-data">1.4</a> to retrieve the HLCA atlas, divide the atlas by dataset and save the splitted data in the following folder: “data/HLCA/”.</p>
</div>
<div id="setting-up-the-environment-2" class="section level3" number="7.2.2">
<h3>
<span class="header-section-number">7.2.2</span> Setting up the environment<a class="anchor" aria-label="anchor" href="#setting-up-the-environment-2"><i class="fas fa-link"></i></a>
</h3>
<p>First we need to specify that we will work with the MetacellAnalysisToolkit conda environment (needed for anndata relying on reticulate and the MCAT tool).
To build the conda environment please follow the instructions on our MetacellAnalysisToolkit <a href="https://github.com/GfellerLab/MetacellToolkit">github repository</a>.</p>
<div class="sourceCode" id="cb161"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rstudio.github.io/reticulate/">reticulate</a></span><span class="op">)</span></span>
<span><span class="va">conda_env</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://rstudio.github.io/reticulate/reference/conda-tools.html">conda_list</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="fu">reticulate</span><span class="fu">::</span><span class="fu"><a href="https://rstudio.github.io/reticulate/reference/conda-tools.html">conda_list</a></span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="va">name</span> <span class="op">==</span> <span class="st">"MetacellAnalysisToolkit"</span>,<span class="st">"python"</span><span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Sys.setenv.html">Sys.setenv</a></span><span class="op">(</span>RETICULATE_PYTHON <span class="op">=</span> <span class="va">conda_env</span><span class="op">)</span></span></code></pre></div>
<pre><code>#&gt;           used  (Mb) gc trigger    (Mb)   max used    (Mb)
#&gt; Ncells 3555050 189.9    6520115   348.3    6520115   348.3
#&gt; Vcells 6717513  51.3 1799339828 13727.9 2245659153 17133.1</code></pre>
<div class="sourceCode" id="cb163"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://satijalab.org/seurat">Seurat</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://anndata.dynverse.org">anndata</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">SuperCell</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">color.celltypes</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'#E5D2DD'</span>, <span class="st">'#53A85F'</span>, <span class="st">'#F1BB72'</span>, <span class="st">'#F3B1A0'</span>, <span class="st">'#D6E7A3'</span>, <span class="st">'#57C3F3'</span>, <span class="st">'#476D87'</span>,</span>
<span>                      <span class="st">'#E95C59'</span>, <span class="st">'#E59CC4'</span>, <span class="st">'#AB3282'</span>, <span class="st">'#23452F'</span>, <span class="st">'#BD956A'</span>, <span class="st">'#8C549C'</span>, <span class="st">'#585658'</span>,</span>
<span>                      <span class="st">'#9FA3A8'</span>, <span class="st">'#E0D4CA'</span>, <span class="st">'#5F3D69'</span>, <span class="st">'#58A4C3'</span>, <span class="st">"#b20000"</span>,<span class="st">'#E4C755'</span>, <span class="st">'#F7F398'</span>,</span>
<span>                      <span class="st">'#AA9A59'</span>, <span class="st">'#E63863'</span>, <span class="st">'#E39A35'</span>, <span class="st">'#C1E6F3'</span>, <span class="st">'#6778AE'</span>, <span class="st">'#91D0BE'</span>, <span class="st">'#B53E2B'</span>,</span>
<span>                      <span class="st">'#712820'</span>, <span class="st">'#DCC1DD'</span>, <span class="st">'#CCE0F5'</span>, <span class="st">'#CCC9E6'</span>, <span class="st">'#625D9E'</span>, <span class="st">'#68A180'</span>, <span class="st">'#3A6963'</span>,</span>
<span>                      <span class="st">'#968175'</span><span class="op">)</span></span></code></pre></div>
</div>
<div id="constructing-supervised-metacell" class="section level3" number="7.2.3">
<h3>
<span class="header-section-number">7.2.3</span> Constructing supervised metacell<a class="anchor" aria-label="anchor" href="#constructing-supervised-metacell"><i class="fas fa-link"></i></a>
</h3>
<p>Sikkema et al. made a remarkable job in finely annotating hundreds thousands of cells.
Within the framework of this re-analysis, let’s now try to use this prior knowledge to obtain slightly better results using a supervised workflow.</p>
<p>We added in section <a href="requirements.html#HLCA-data">1.4</a> a <code>ann_sample</code> column in the metadata of the single cell object.
We now can use it to build metacell for each cell type in each sample.</p>
<p>If you are limited in memory you should still be able to process the samples by reducing the number of cores (e.g. <code>-l 3</code>) or
by sequentially processing the samples (just remove the <code>-l</code>) in a slightly longer time</p>
<p>This should take around 30 minutes.</p>
<p>To call the MCAT command line, please define your path to the gihub cloned repository optained from this <a href="https://github.com/GfellerLab/MetacellToolkit">github repository</a>.</p>
<div class="sourceCode" id="cb164"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb164-1"><a href="integration.html#cb164-1" aria-hidden="true" tabindex="-1"></a><span class="co">#git clone https://github.com/GfellerLab/MetacellAnalysisToolkit</span></span>
<span id="cb164-2"><a href="integration.html#cb164-2" aria-hidden="true" tabindex="-1"></a><span class="va">MCAT_path</span><span class="op">=</span>MetacellAnalysisToolkit/</span>
<span id="cb164-3"><a href="integration.html#cb164-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> d <span class="kw">in</span> data/HLCA/datasets/<span class="pp">*</span><span class="kw">;</span></span>
<span id="cb164-4"><a href="integration.html#cb164-4" aria-hidden="true" tabindex="-1"></a><span class="cf">do</span> <span class="va">${MCAT_path}</span><span class="ex">cli/MCAT</span> <span class="at">-t</span> SuperCell <span class="at">-i</span> <span class="va">$d</span>/sc_adata.h5ad <span class="at">-o</span> <span class="va">$d</span>/sup_mc <span class="at">-a</span> ann_sample <span class="at">-l</span> 3 <span class="at">-n</span> 50 <span class="at">-f</span> 2000 <span class="at">-k</span> 30 <span class="at">-g</span> 50 <span class="at">-s</span> adata</span>
<span id="cb164-5"><a href="integration.html#cb164-5" aria-hidden="true" tabindex="-1"></a><span class="cf">done</span></span></code></pre></div>
</div>
<div id="load-metacell-objects" class="section level3" number="7.2.4">
<h3>
<span class="header-section-number">7.2.4</span> Load metacell objects<a class="anchor" aria-label="anchor" href="#load-metacell-objects"><i class="fas fa-link"></i></a>
</h3>
<p>We load the .h5ad objects and directly convert them in Seurat objects to benefit from all the functions of this framework.
To consider the datasets in the same order as the one used in this tutorial we run the following chunk before loading the metacell objects.</p>
<div class="sourceCode" id="cb165"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://anndata.dynverse.org">anndata</a></span><span class="op">)</span></span>
<span><span class="va">adata</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://anndata.dynverse.org/reference/read_h5ad.html">read_h5ad</a></span><span class="op">(</span><span class="st">"data/HLCA/local.h5ad"</span>,backed <span class="op">=</span> <span class="st">"r"</span><span class="op">)</span></span>
<span><span class="va">adata</span><span class="op">$</span><span class="va">var_names</span> <span class="op">&lt;-</span> <span class="va">adata</span><span class="op">$</span><span class="va">var</span><span class="op">$</span><span class="va">feature_name</span> <span class="co"># We will use gene short name for downstream analyses</span></span>
<span><span class="va">datasets</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">adata</span><span class="op">$</span><span class="va">obs</span><span class="op">$</span><span class="va">dat</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span><span class="op">(</span><span class="va">adata</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/gc.html">gc</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb166"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">metacell.files</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">datasets</span>, FUN <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"data/HLCA/datasets/"</span>,<span class="va">x</span>,<span class="st">"/sup_mc/mc_adata.h5ad"</span><span class="op">)</span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="va">metacell.objs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">metacell.files</span>, <span class="kw">function</span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">adata</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://anndata.dynverse.org/reference/read_h5ad.html">read_h5ad</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span></span>
<span>  <span class="va">countMatrix</span> <span class="op">&lt;-</span> <span class="fu">Matrix</span><span class="fu">::</span><span class="fu">t</span><span class="op">(</span><span class="va">adata</span><span class="op">$</span><span class="va">X</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">countMatrix</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">adata</span><span class="op">$</span><span class="va">obs_names</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">countMatrix</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">adata</span><span class="op">$</span><span class="va">var_names</span></span>
<span>  <span class="va">sobj</span> <span class="op">&lt;-</span> <span class="fu">Seurat</span><span class="fu">::</span><span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/CreateSeuratObject.html">CreateSeuratObject</a></span><span class="op">(</span>counts <span class="op">=</span> <span class="va">countMatrix</span>,meta.data <span class="op">=</span> <span class="va">adata</span><span class="op">$</span><span class="va">obs</span><span class="op">)</span></span>
<span>  <span class="va">sobj</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/RenameCells.html">RenameCells</a></span><span class="op">(</span><span class="va">sobj</span>, add.cell.id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">sobj</span><span class="op">$</span><span class="va">sample</span><span class="op">)</span><span class="op">)</span> <span class="co"># we give unique name to metacells</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">sobj</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
</div>
<div id="merging-objects-and-basic-quality-control-1" class="section level3" number="7.2.5">
<h3>
<span class="header-section-number">7.2.5</span> Merging objects and basic quality control<a class="anchor" aria-label="anchor" href="#merging-objects-and-basic-quality-control-1"><i class="fas fa-link"></i></a>
</h3>
<p>Given the single-cell metadata, the MCAT tool automatically assigns annotations to metacells and
computes purities for all the categorical variables present in the metadata of the input single-cell object.</p>
<p>Thus, let’s check the purity of our metacells at different level of annotations, as well as their size (number of single cells they contain).</p>
<p>To do so we merge the objects together and use Seurat <code>VlnPlot</code> function.</p>
<div class="sourceCode" id="cb167"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">unintegrated.mc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html">merge</a></span><span class="op">(</span><span class="va">metacell.objs</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="va">metacell.objs</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://satijalab.org/seurat/reference/VlnPlot.html">VlnPlot</a></span><span class="op">(</span><span class="va">unintegrated.mc</span><span class="op">[</span>, <span class="va">unintegrated.mc</span><span class="op">$</span><span class="va">ann_level_3</span> <span class="op">!=</span> <span class="st">"None"</span><span class="op">]</span>, features <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"size"</span>, <span class="st">"ann_level_2_purity"</span><span class="op">)</span>, group.by <span class="op">=</span> <span class="st">'dataset'</span>, pt.size <span class="op">=</span> <span class="fl">0.001</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in SingleExIPlot(type = type, data = data[, x, drop = FALSE], idents =</span></span>
<span><span class="co">#&gt; idents, : All cells have the same value of ann_level_2_purity.</span></span></code></pre></div>
<div class="inline-figure"><img src="40-integration_analysis_files/figure-html/unnamed-chunk-17-1.png" width="672"></div>
<div class="sourceCode" id="cb168"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://satijalab.org/seurat/reference/VlnPlot.html">VlnPlot</a></span><span class="op">(</span><span class="va">unintegrated.mc</span><span class="op">[</span>, <span class="va">unintegrated.mc</span><span class="op">$</span><span class="va">ann_level_3</span> <span class="op">!=</span> <span class="st">"None"</span><span class="op">]</span>, features <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"ann_level_3_purity"</span>, <span class="st">"ann_level_4_purity"</span><span class="op">)</span>, group.by <span class="op">=</span> <span class="st">'dataset'</span>, pt.size <span class="op">=</span> <span class="fl">0.001</span>,  ncol<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in SingleExIPlot(type = type, data = data[, x, drop = FALSE], idents =</span></span>
<span><span class="co">#&gt; idents, : All cells have the same value of ann_level_3_purity.</span></span></code></pre></div>
<div class="inline-figure"><img src="40-integration_analysis_files/figure-html/unnamed-chunk-17-2.png" width="672"></div>
<p>We can also use box plots.</p>
<div class="sourceCode" id="cb169"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p_4</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">unintegrated.mc</span><span class="op">@</span><span class="va">meta.data</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">dataset</span>, y <span class="op">=</span> <span class="va">ann_level_4_purity</span>, fill <span class="op">=</span> <span class="va">dataset</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html">geom_boxplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_discrete.html">scale_x_discrete</a></span><span class="op">(</span>guide <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_axis.html">guide_axis</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">45</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"sup metacells level 4 purity"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/SeuratTheme.html">NoLegend</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html">ylim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p_finest</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">unintegrated.mc</span><span class="op">@</span><span class="va">meta.data</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">dataset</span>, y <span class="op">=</span> <span class="va">ann_finest_level_purity</span>, fill <span class="op">=</span> <span class="va">dataset</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html">geom_boxplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_discrete.html">scale_x_discrete</a></span><span class="op">(</span>guide <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_axis.html">guide_axis</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">45</span><span class="op">)</span><span class="op">)</span>  <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"sup metacells finest level purity"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/SeuratTheme.html">NoLegend</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html">ylim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p_4</span> <span class="op">+</span> <span class="va">p_finest</span></span></code></pre></div>
<div class="inline-figure"><img src="40-integration_analysis_files/figure-html/unnamed-chunk-18-1.png" width="672"></div>
<p>Overall using supervised metacells construction we obtain pure metacells until the 3rd level of annotation and
improve metacell purities for finer levels compared to the unsupervised approach (see previous section @ref(integration_unsupervised)).</p>
<div class="sourceCode" id="cb170"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">meta.data.unsup</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"data/HLCA/combined.mc.unsup.rds"</span><span class="op">)</span><span class="op">@</span><span class="va">meta.data</span></span>
<span></span>
<span><span class="va">p_4_unsup</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">meta.data.unsup</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">dataset</span>, y <span class="op">=</span> <span class="va">ann_level_4_purity</span>, fill <span class="op">=</span> <span class="va">dataset</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html">geom_boxplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_discrete.html">scale_x_discrete</a></span><span class="op">(</span>guide <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_axis.html">guide_axis</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">45</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"unsup metacells level 4 purity"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/SeuratTheme.html">NoLegend</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html">ylim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p_finest_unsup</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">meta.data.unsup</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">dataset</span>, y <span class="op">=</span> <span class="va">ann_finest_level_purity</span>, fill <span class="op">=</span> <span class="va">dataset</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html">geom_boxplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_discrete.html">scale_x_discrete</a></span><span class="op">(</span>guide <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_axis.html">guide_axis</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">45</span><span class="op">)</span><span class="op">)</span>  <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"unsup metacells finest level purity"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/SeuratTheme.html">NoLegend</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html">ylim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p_4_unsup</span> <span class="op">|</span> <span class="va">p_4</span></span></code></pre></div>
<div class="inline-figure"><img src="40-integration_analysis_files/figure-html/unnamed-chunk-19-1.png" width="1344"></div>
<div class="sourceCode" id="cb171"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p_finest_unsup</span> <span class="op">+</span> <span class="va">p_finest</span></span></code></pre></div>
<div class="inline-figure"><img src="40-integration_analysis_files/figure-html/unnamed-chunk-19-2.png" width="1344"></div>
</div>
<div id="unintegrated-analysis-1" class="section level3" number="7.2.6">
<h3>
<span class="header-section-number">7.2.6</span> Unintegrated analysis<a class="anchor" aria-label="anchor" href="#unintegrated-analysis-1"><i class="fas fa-link"></i></a>
</h3>
<p>Let’s first do a standard dimensionality reduction without batch correction.</p>
<div class="sourceCode" id="cb172"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/DefaultAssay.html">DefaultAssay</a></span><span class="op">(</span><span class="va">unintegrated.mc</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"RNA"</span></span>
<span><span class="va">unintegrated.mc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/NormalizeData.html">NormalizeData</a></span><span class="op">(</span><span class="va">unintegrated.mc</span><span class="op">)</span></span>
<span><span class="va">unintegrated.mc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/FindVariableFeatures.html">FindVariableFeatures</a></span><span class="op">(</span><span class="va">unintegrated.mc</span><span class="op">)</span></span>
<span><span class="va">unintegrated.mc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/ScaleData.html">ScaleData</a></span><span class="op">(</span><span class="va">unintegrated.mc</span><span class="op">)</span></span>
<span><span class="va">unintegrated.mc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/RunPCA.html">RunPCA</a></span><span class="op">(</span><span class="va">unintegrated.mc</span><span class="op">)</span></span>
<span><span class="va">unintegrated.mc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/RunUMAP.html">RunUMAP</a></span><span class="op">(</span><span class="va">unintegrated.mc</span>,dims <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">30</span><span class="op">)</span></span>
<span></span>
<span><span class="va">umap.unintegrated.datasets</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/DimPlot.html">DimPlot</a></span><span class="op">(</span><span class="va">unintegrated.mc</span>,reduction <span class="op">=</span> <span class="st">"umap"</span>,group.by <span class="op">=</span> <span class="st">"dataset"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/SeuratTheme.html">NoLegend</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"unintegrated datasets"</span><span class="op">)</span></span>
<span><span class="va">umap.unintegrated.types</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/DimPlot.html">DimPlot</a></span><span class="op">(</span><span class="va">unintegrated.mc</span>,reduction <span class="op">=</span> <span class="st">"umap"</span>,group.by <span class="op">=</span> <span class="st">"ann_level_2"</span>,label <span class="op">=</span> <span class="cn">T</span>,repel <span class="op">=</span> <span class="cn">T</span>,cols <span class="op">=</span> <span class="va">color.celltypes</span><span class="op">)</span><span class="op">+</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/SeuratTheme.html">NoLegend</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"unintegrated cell types"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">umap.unintegrated.datasets</span> <span class="op">+</span> <span class="va">umap.unintegrated.types</span></span></code></pre></div>
<div class="inline-figure"><img src="40-integration_analysis_files/figure-html/unnamed-chunk-20-1.png" width="1344"></div>
<p>You can see on the plots that a batch effect is clearly present at the metacell level. Let’s correct it using a supervised approach.</p>
</div>
<div id="stacas-integration" class="section level3" number="7.2.7">
<h3>
<span class="header-section-number">7.2.7</span> STACAS integration<a class="anchor" aria-label="anchor" href="#stacas-integration"><i class="fas fa-link"></i></a>
</h3>
<p>In the original study, datasets were integrated using SCANVI semi-supervised integration using partial annotation obtained for each dataset prior integration.
Here in this second example we propose to use a similar approach in R using <a href="https://github.com/carmonalab/STACAS">STACAS</a>. We will use the “<code>ann</code>” labels we used to construct the metacells (3rd level of annotation if available for the cell, otherwise 2nd level).</p>
<p>To be noted that, as in the original study, we use the dataset rather than the donor as the batch parameter. See method section <a href="https://www.nature.com/articles/s41591-023-02327-2">Data integration benchmarking</a> of the original study for more details.</p>
<div class="sourceCode" id="cb173"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Install package if needed</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html">requireNamespace</a></span><span class="op">(</span><span class="st">"STACAS"</span><span class="op">)</span><span class="op">)</span> <span class="fu">remotes</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html">install_github</a></span><span class="op">(</span><span class="st">"carmonalab/STACAS"</span>, upgrade <span class="op">=</span> <span class="st">"never"</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">STACAS</span><span class="op">)</span></span>
<span></span>
<span><span class="va">t0_integration</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">n.metacells</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">metacell.objs</span>, FUN <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">}</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">n.metacells</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">datasets</span></span>
<span><span class="va">ref.names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort</a></span><span class="op">(</span><span class="va">n.metacells</span>,decreasing <span class="op">=</span> <span class="cn">T</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span></span>
<span><span class="va">ref.index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">datasets</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">ref.names</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># normalize and identify variable features for each dataset independently</span></span>
<span><span class="va">metacell.objs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">metacell.objs</span>, FUN <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/DefaultAssay.html">DefaultAssay</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"RNA"</span>;</span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/RenameCells.html">RenameCells</a></span><span class="op">(</span><span class="va">x</span>, add.cell.id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">sample</span><span class="op">)</span><span class="op">)</span> <span class="co"># we give unique name to metacells</span></span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/NormalizeData.html">NormalizeData</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">}</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/gc.html">gc</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># Perform a supervised integration of the dataset using STACAS</span></span>
<span><span class="va">combined.mc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/STACAS/man/Run.STACAS.html">Run.STACAS</a></span><span class="op">(</span>object.list <span class="op">=</span> <span class="va">metacell.objs</span>,</span>
<span>                          anchor.features <span class="op">=</span> <span class="fl">2000</span>,</span>
<span>                          min.sample.size <span class="op">=</span> <span class="fl">80</span>,</span>
<span>                          k.weight <span class="op">=</span> <span class="fl">80</span>, <span class="co">#smallest dataset contains 86 metacells</span></span>
<span>                          cell.labels <span class="op">=</span> <span class="st">"ann"</span>, <span class="co"># Note that by not you can use STACAS in its unsupervised mode</span></span>
<span>                          reference <span class="op">=</span> <span class="va">ref.index</span>, <span class="co"># the 5 biggest datasets are used as reference</span></span>
<span>                          dims <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">30</span><span class="op">)</span></span>
<span></span>
<span><span class="va">tf_integration</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">tf_integration</span> <span class="op">-</span> <span class="va">t0_integration</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rm.html">remove</a></span><span class="op">(</span><span class="va">metacell.objs</span><span class="op">)</span> <span class="co"># We don't need the object list anymore</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/gc.html">gc</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>Check the obtained object:</p>
<div class="sourceCode" id="cb174"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">combined.mc</span></span>
<span><span class="co">#&gt; An object of class Seurat </span></span>
<span><span class="co">#&gt; 30024 features across 12914 samples within 2 assays </span></span>
<span><span class="co">#&gt; Active assay: integrated (2000 features, 2000 variable features)</span></span>
<span><span class="co">#&gt;  1 other assay present: RNA</span></span>
<span><span class="co">#&gt;  1 dimensional reduction calculated: pca</span></span></code></pre></div>
<p>We can verify that the sum of metacell sizes correspond to the original number of single-cells</p>
<div class="sourceCode" id="cb175"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">combined.mc</span><span class="op">$</span><span class="va">size</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 584944</span></span></code></pre></div>
<p>STACAS directly returns a pca for the slot <code>"integrated"</code> that we can use to make a UMAP of the corrected data.</p>
<div class="sourceCode" id="cb176"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/DefaultAssay.html">DefaultAssay</a></span><span class="op">(</span><span class="va">combined.mc</span><span class="op">)</span> <span class="op">=</span> <span class="st">"integrated"</span></span>
<span></span>
<span><span class="va">combined.mc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/RunUMAP.html">RunUMAP</a></span><span class="op">(</span><span class="va">combined.mc</span>, dims <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">30</span>, reduction <span class="op">=</span>  <span class="st">"pca"</span>, reduction.name <span class="op">=</span> <span class="st">"umap"</span><span class="op">)</span></span></code></pre></div>
<p>Now we can make the plots and visually compare the results with the unintegrated analysis.</p>
<div class="sourceCode" id="cb177"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">umap.stacas.datasets</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/DimPlot.html">DimPlot</a></span><span class="op">(</span><span class="va">combined.mc</span>,reduction <span class="op">=</span> <span class="st">"umap"</span>,group.by <span class="op">=</span> <span class="st">"dataset"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/SeuratTheme.html">NoLegend</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"integrated datasets"</span><span class="op">)</span></span>
<span><span class="va">umap.stacas.celltypes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/DimPlot.html">DimPlot</a></span><span class="op">(</span><span class="va">combined.mc</span>,reduction <span class="op">=</span> <span class="st">"umap"</span>,group.by <span class="op">=</span> <span class="st">"ann_level_2"</span>,label <span class="op">=</span> <span class="cn">T</span>,repel <span class="op">=</span> <span class="cn">T</span>,cols <span class="op">=</span> <span class="va">color.celltypes</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/SeuratTheme.html">NoLegend</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"integrated cell types"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">umap.stacas.datasets</span> <span class="op">+</span> <span class="va">umap.stacas.celltypes</span> <span class="op">+</span> <span class="va">umap.unintegrated.datasets</span> <span class="op">+</span> <span class="va">umap.unintegrated.types</span></span></code></pre></div>
<div class="inline-figure"><img src="40-integration_analysis_files/figure-html/unnamed-chunk-25-1.png" width="1152"></div>
<p>STACAS efficiently corrected the batch effect in the data while keeping the cell type separated.</p>
<p>We can navigate in the different annotation levels.</p>
<div class="sourceCode" id="cb178"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://satijalab.org/seurat/reference/DimPlot.html">DimPlot</a></span><span class="op">(</span><span class="va">combined.mc</span>,group.by <span class="op">=</span> <span class="st">"ann_level_1"</span>,reduction <span class="op">=</span> <span class="st">"umap"</span>,cols<span class="op">=</span> <span class="va">color.celltypes</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="40-integration_analysis_files/figure-html/unnamed-chunk-26-1.png" width="672"></div>
<div class="sourceCode" id="cb179"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="https://satijalab.org/seurat/reference/DimPlot.html">DimPlot</a></span><span class="op">(</span><span class="va">combined.mc</span>,group.by <span class="op">=</span> <span class="st">"ann_level_2"</span>,reduction <span class="op">=</span> <span class="st">"umap"</span>,label <span class="op">=</span> <span class="cn">T</span>,repel <span class="op">=</span> <span class="cn">T</span>,cols<span class="op">=</span> <span class="va">color.celltypes</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="40-integration_analysis_files/figure-html/unnamed-chunk-26-2.png" width="672"></div>
<div class="sourceCode" id="cb180"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="https://satijalab.org/seurat/reference/DimPlot.html">DimPlot</a></span><span class="op">(</span><span class="va">combined.mc</span>,group.by <span class="op">=</span> <span class="st">"ann_level_3"</span>,reduction <span class="op">=</span> <span class="st">"umap"</span>,label <span class="op">=</span> <span class="cn">T</span>, repel <span class="op">=</span> <span class="cn">T</span>,cols<span class="op">=</span> <span class="va">color.celltypes</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/SeuratTheme.html">NoLegend</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="40-integration_analysis_files/figure-html/unnamed-chunk-26-3.png" width="672"></div>
</div>
<div id="comparison-with-unsupervised-analysis" class="section level3" number="7.2.8">
<h3>
<span class="header-section-number">7.2.8</span> Comparison with unsupervised analysis<a class="anchor" aria-label="anchor" href="#comparison-with-unsupervised-analysis"><i class="fas fa-link"></i></a>
</h3>
<p>we can quickly visually compare these results with the unsupervised integration obtained with Seurat:</p>
<div class="sourceCode" id="cb181"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">combined.mc.unsup</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"data/HLCA/combined.mc.unsup.rds"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">combined.mc</span><span class="op">$</span><span class="va">ann_level_3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">combined.mc</span><span class="op">$</span><span class="va">ann_level_3</span><span class="op">)</span></span>
<span><span class="va">matched.color.celltypes</span> <span class="op">&lt;-</span> <span class="va">color.celltypes</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="va">combined.mc</span><span class="op">$</span><span class="va">ann_level_3</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">matched.color.celltypes</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="va">combined.mc</span><span class="op">$</span><span class="va">ann_level_3</span><span class="op">)</span></span>
<span></span>
<span><span class="va">level3_sup</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/DimPlot.html">DimPlot</a></span><span class="op">(</span><span class="va">combined.mc</span>,group.by <span class="op">=</span> <span class="st">"ann_level_3"</span>,reduction <span class="op">=</span> <span class="st">"umap"</span>,label <span class="op">=</span> <span class="cn">T</span>, repel <span class="op">=</span> <span class="cn">T</span>,cols<span class="op">=</span> <span class="va">matched.color.celltypes</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/SeuratTheme.html">NoLegend</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Sup workflow"</span><span class="op">)</span></span>
<span><span class="va">level3_unsup</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/DimPlot.html">DimPlot</a></span><span class="op">(</span><span class="va">combined.mc.unsup</span>,group.by <span class="op">=</span> <span class="st">"ann_level_3"</span>,reduction <span class="op">=</span> <span class="st">"umap"</span>,label <span class="op">=</span> <span class="cn">T</span>, repel <span class="op">=</span> <span class="cn">T</span>,cols<span class="op">=</span> <span class="va">matched.color.celltypes</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/SeuratTheme.html">NoLegend</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Unsup workflow"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">level3_sup</span> <span class="op">+</span> <span class="va">level3_unsup</span></span></code></pre></div>
<div class="inline-figure"><img src="40-integration_analysis_files/figure-html/unnamed-chunk-27-1.png" width="1344"></div>
<p>Look at epithelial cells in particular</p>
<div class="sourceCode" id="cb182"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">level3_sup</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/DimPlot.html">DimPlot</a></span><span class="op">(</span><span class="va">combined.mc</span><span class="op">[</span>,<span class="va">combined.mc</span><span class="op">$</span><span class="va">ann_level_1</span> <span class="op">==</span> <span class="st">"Epithelial"</span><span class="op">]</span>,group.by <span class="op">=</span> <span class="st">"ann_level_3"</span>,reduction <span class="op">=</span> <span class="st">"umap"</span>,label <span class="op">=</span> <span class="cn">T</span>, repel <span class="op">=</span> <span class="cn">T</span>,cols<span class="op">=</span> <span class="va">matched.color.celltypes</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/SeuratTheme.html">NoLegend</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Sup workflow"</span><span class="op">)</span></span>
<span><span class="va">level3_unsup</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/DimPlot.html">DimPlot</a></span><span class="op">(</span><span class="va">combined.mc.unsup</span><span class="op">[</span>,<span class="va">combined.mc.unsup</span><span class="op">$</span><span class="va">ann_level_1</span> <span class="op">==</span> <span class="st">"Epithelial"</span><span class="op">]</span>,group.by <span class="op">=</span> <span class="st">"ann_level_3"</span>,reduction <span class="op">=</span> <span class="st">"umap"</span>,label <span class="op">=</span> <span class="cn">T</span>, repel <span class="op">=</span> <span class="cn">T</span>,cols<span class="op">=</span> <span class="va">matched.color.celltypes</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/SeuratTheme.html">NoLegend</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Unsup workflow"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">level3_sup</span> <span class="op">+</span> <span class="va">level3_unsup</span></span></code></pre></div>
<div class="inline-figure"><img src="40-integration_analysis_files/figure-html/unnamed-chunk-28-1.png" width="1344"></div>
</div>
<div id="downstream-analysis-2" class="section level3" number="7.2.9">
<h3>
<span class="header-section-number">7.2.9</span> Downstream analysis<a class="anchor" aria-label="anchor" href="#downstream-analysis-2"><i class="fas fa-link"></i></a>
</h3>
<p>You can try conduce the same downstream analyses as in the previous example @ref(integration_unsupervised) (clustering, cell type abundances, DEG …).</p>
<p>Here to show you the interest of supervised workflow with pure metacell we can zoom on the smooth muscle sub types. Despite the low metacell number for each cell type these different subtypes are separated on the UMAP, especially the rare FAM83D+ smooth muscles that were discovered in the original study.</p>
<div class="sourceCode" id="cb183"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">combined.mc</span><span class="op">$</span><span class="va">ann</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">combined.mc</span><span class="op">$</span><span class="va">ann</span><span class="op">)</span></span>
<span><span class="va">color.celltypes.ann</span> <span class="op">&lt;-</span> <span class="va">color.celltypes</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="va">combined.mc</span><span class="op">$</span><span class="va">ann</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">color.celltypes.ann</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="va">combined.mc</span><span class="op">$</span><span class="va">ann</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://satijalab.org/seurat/reference/DimPlot.html">DimPlot</a></span><span class="op">(</span><span class="va">combined.mc</span><span class="op">[</span>,<span class="va">combined.mc</span><span class="op">$</span><span class="va">ann_level_2</span> <span class="op">==</span> <span class="st">"Smooth muscle"</span><span class="op">]</span>,group.by <span class="op">=</span> <span class="st">"ann"</span>,cols <span class="op">=</span> <span class="va">color.celltypes.ann</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="40-integration_analysis_files/figure-html/unnamed-chunk-29-1.png" width="672"></div>
<p>Using a DEG analysis we can check if we retrieve their markers. MYH11 and CNN1 genes are canonical smooth muscle markers while FAM83D was found uniquely and consistently expressed by this rare cell type in the original study</p>
<div class="sourceCode" id="cb184"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/DefaultAssay.html">DefaultAssay</a></span><span class="op">(</span><span class="va">combined.mc</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"RNA"</span></span>
<span><span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/Idents.html">Idents</a></span><span class="op">(</span><span class="va">combined.mc</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"ann"</span></span>
<span><span class="va">markersSmoothMuscle</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/FindMarkers.html">FindMarkers</a></span><span class="op">(</span><span class="va">combined.mc</span>,ident.1 <span class="op">=</span> <span class="st">"Smooth muscle FAM83D+"</span>,only.pos <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">markersSmoothMuscle</span><span class="op">)</span></span>
<span><span class="co">#&gt;               p_val avg_log2FC pct.1 pct.2     p_val_adj</span></span>
<span><span class="co">#&gt; MYOCD 1.889342e-175  1.3869594 0.758 0.022 5.294693e-171</span></span>
<span><span class="co">#&gt; ASB5  1.754802e-130  0.2913375 0.303 0.004 4.917658e-126</span></span>
<span><span class="co">#&gt; NMRK2 1.103717e-129  0.4245135 0.273 0.003 3.093057e-125</span></span>
<span><span class="co">#&gt; PLN   1.568445e-124  3.1280687 0.879 0.044 4.395411e-120</span></span>
<span><span class="co">#&gt; HSPB3 7.379856e-121  1.0364463 0.545 0.016 2.068131e-116</span></span>
<span><span class="co">#&gt; CASQ2 4.376973e-117  1.1063566 0.636 0.023 1.226603e-112</span></span>
<span></span>
<span><span class="va">markersSmoothMuscle</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"MYH11"</span>,<span class="st">"CNN1"</span>,<span class="st">"FAM83D"</span><span class="op">)</span>,<span class="op">]</span></span>
<span><span class="co">#&gt;               p_val avg_log2FC pct.1 pct.2    p_val_adj</span></span>
<span><span class="co">#&gt; MYH11  2.596787e-32   4.248525 0.970 0.287 7.277236e-28</span></span>
<span><span class="co">#&gt; CNN1   7.220235e-71   4.623065 0.970 0.106 2.023399e-66</span></span>
<span><span class="co">#&gt; FAM83D 3.561820e-11   2.186449 0.636 0.285 9.981643e-07</span></span>
<span></span>
<span><span class="co"># Many classical smooth muscles cells are not annotated at the 3rd level of annotation (labelled None)</span></span>
<span><span class="fu"><a href="https://satijalab.org/seurat/reference/VlnPlot.html">VlnPlot</a></span><span class="op">(</span><span class="va">combined.mc</span>,features <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"MYH11"</span>,<span class="st">"CNN1"</span>,<span class="st">"FAM83D"</span><span class="op">)</span>,group.by <span class="op">=</span> <span class="st">"ann"</span>,ncol <span class="op">=</span> <span class="fl">2</span>,cols <span class="op">=</span> <span class="va">color.celltypes.ann</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="40-integration_analysis_files/figure-html/unnamed-chunk-30-1.png" width="1152"></div>
</div>
<div id="conclusion-1" class="section level3" number="7.2.10">
<h3>
<span class="header-section-number">7.2.10</span> Conclusion<a class="anchor" aria-label="anchor" href="#conclusion-1"><i class="fas fa-link"></i></a>
</h3>
<p>Taking advantage of the single cell annotation in a supervised workflow we could improve the precision of our metacell re-analysis.
When cell annotations are given and of good quality, which is far from being the case every time, building metacells accordingly and
use a supervised integration workflow should be preferred.</p>
<p>To be noted that we used an intermediary level of annotation to supervise our analysis, using a finer level for this data would have resulted
in a longer time for metacell building. PLus, we would have obtained to few metacells per cell type in the different sample to be able to
make an efficient supervised batch correction with STACAS.</p>
<p>To be more precise at the cost of computational efficiency one could also try to reduce the graining level of the analysis (using a graining level of 20 for instance),</p>
<p>To conclude, keep in mind that in one hand, for certain analysis such as rare cell type analysis,
we will never achieve the same level of sensitivity with metacells compared to single-cells.
On the other hand, you certainly won’t be able to analyze so many single-cells so easily, and you may not need extremely fine cell-type resolution for many analyses.</p>

</div>
</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="command-line.html"><span class="header-section-number">6</span> Metacell Analysis Toolkit (MCAT)</a></div>
<div class="next"><a href="references.html">References</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#integration"><span class="header-section-number">7</span> Integration of metacells</a></li>
<li>
<a class="nav-link" href="#integration_unsupervised"><span class="header-section-number">7.1</span> Unsupervised integration</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#data-loading-3"><span class="header-section-number">7.1.1</span> Data loading</a></li>
<li><a class="nav-link" href="#setting-up-the-environment-1"><span class="header-section-number">7.1.2</span> Setting up the environment</a></li>
<li><a class="nav-link" href="#building-metacell"><span class="header-section-number">7.1.3</span> Building metacell</a></li>
<li><a class="nav-link" href="#loading-metacell-objects"><span class="header-section-number">7.1.4</span> Loading metacell objects</a></li>
<li><a class="nav-link" href="#merging-objects-and-basic-quality-control"><span class="header-section-number">7.1.5</span> Merging objects and basic quality control</a></li>
<li><a class="nav-link" href="#unintegrated-analysis"><span class="header-section-number">7.1.6</span> Unintegrated analysis</a></li>
<li><a class="nav-link" href="#seurat-integration"><span class="header-section-number">7.1.7</span> Seurat integration</a></li>
<li><a class="nav-link" href="#downstream-analysis-1"><span class="header-section-number">7.1.8</span> Downstream analysis</a></li>
<li><a class="nav-link" href="#conclusion"><span class="header-section-number">7.1.9</span> Conclusion</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#integration_supervised"><span class="header-section-number">7.2</span> Supervised integration</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#data-loading-4"><span class="header-section-number">7.2.1</span> Data loading</a></li>
<li><a class="nav-link" href="#setting-up-the-environment-2"><span class="header-section-number">7.2.2</span> Setting up the environment</a></li>
<li><a class="nav-link" href="#constructing-supervised-metacell"><span class="header-section-number">7.2.3</span> Constructing supervised metacell</a></li>
<li><a class="nav-link" href="#load-metacell-objects"><span class="header-section-number">7.2.4</span> Load metacell objects</a></li>
<li><a class="nav-link" href="#merging-objects-and-basic-quality-control-1"><span class="header-section-number">7.2.5</span> Merging objects and basic quality control</a></li>
<li><a class="nav-link" href="#unintegrated-analysis-1"><span class="header-section-number">7.2.6</span> Unintegrated analysis</a></li>
<li><a class="nav-link" href="#stacas-integration"><span class="header-section-number">7.2.7</span> STACAS integration</a></li>
<li><a class="nav-link" href="#comparison-with-unsupervised-analysis"><span class="header-section-number">7.2.8</span> Comparison with unsupervised analysis</a></li>
<li><a class="nav-link" href="#downstream-analysis-2"><span class="header-section-number">7.2.9</span> Downstream analysis</a></li>
<li><a class="nav-link" href="#conclusion-1"><span class="header-section-number">7.2.10</span> Conclusion</a></li>
</ul>
</li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/GfellerLab/MetacellAnalysisTutorial/blob/main/40-integration_analysis.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/GfellerLab/MetacellAnalysisTutorial/edit/main/40-integration_analysis.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Metacell Analysis Tutorial</strong>" was written by Aurélie Gabriel, Léonard Hérault, Mariia Bilous, David Gfeller. It was last built on 2023-11-24.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer>
</body>
</html>
