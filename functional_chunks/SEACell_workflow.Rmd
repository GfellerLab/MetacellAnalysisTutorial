
[//]: # (This file runs standard SEACell pipeline, make sure that the following object exist: ad, gamma )

```{r, include=FALSE}
# include this section if your child (nested) .Rmd has plot output. This make sure that plot is saved in correct location and displayed in rendered book. Mb not the best solution, but it works :) 
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

#### Setting up SEACells parameters {-}
```{python seacells-parameters}
## User defined parameters
build_kernel_on = 'X_pca' # key in ad.obsm to use for computing metacells
                          # This would be replaced by 'X_svd' for ATAC data
## Additional parameters
n_waypoint_eigs = 10      # Number of eigenvalues to consider when initializing metacells
n_iter = 50
```

#### Initialize the SEACell model {-}
```{python seacells-model-initialization, cache = TO_CACHE}
# set seed for reproducibility 
random.seed(123)

# The number of SEACells is computed as a ratio between the number of single cells and the desired graining level

n_SEACells = int(ad.shape[0]/gamma) 

model = SEACells.core.SEACells(ad, 
                  build_kernel_on=build_kernel_on, 
                  n_SEACells=n_SEACells, 
                  n_waypoint_eigs=n_waypoint_eigs,
                  convergence_epsilon = 1e-5,
                  verbose = True)
```


```{python seacells-model-kernel, cache = TO_CACHE, warning = FALSE, message = FALSE, results = FALSE}
model.construct_kernel_matrix()
M = model.kernel_matrix
```



```{python seacells-model-init, cache = TO_CACHE}
# Initialize archetypes
model.initialize_archetypes()
    
# Plot the initialization to ensure they are evenly spread
SEACells.plot.plot_initialization(ad, model, plot_basis='X_umap') ## error, mb missing some modules
```



#### Fitting model {-}
```{python seacells-model-fit, cache = TO_CACHE}
## fit model
model.fit(min_iter = 10, max_iter = n_iter)
```
#### Check model convergence {-}
```{python seacells-convergence, cache = TO_CACHE}
# Check for convergence 
model.plot_convergence()
```


#### Aggregate metacells {-}
`membership` 
```{python seacells-get-membeship, cache = TO_CACHE}
membership = model.get_hard_assignments()

# aggregate metacells    
mc_ad = SEACells.core.summarize_by_SEACell(ad, SEACells_label='SEACell', summarize_layer='raw')

# make `membership` numeric
d = {x: int(i)+1 for i, x in enumerate(mc_ad.obs_names)}
ad.obs.merge(membership)
ad.obs['membership'] = [d[x] for x in membership.SEACell]

```

#### Project metacells on the single-cell umap {-}
```{python seacells-umap, cache = TO_CACHE, warning = FALSE, message = FALSE, results = FALSE}
SEACells.plot.plot_2D(ad, key='X_umap', colour_metacells=True)
```
